{% extends "base.html" %}

{% block title %}Панель менеджера | InBack{% endblock %}

{% block content %}
<style>
.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}

.tab-button:hover {
    color: #374151 !important;
    border-color: #D1D5DB !important;
}

/* Internal favorites tabs */
.favorites-tab-content {
    display: none;
}

.favorites-tab-content.active {
    display: block;
}

.favorites-tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}
</style>

<!-- Tab Navigation under main header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-4">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#0088CC] to-[#006699] flex items-center justify-center">
                        <span class="text-white font-semibold">{{ current_manager.full_name[0] }}</span>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-gray-900">{{ current_manager.full_name }}</p>
                        <p class="text-sm text-gray-500">Менеджер недвижимости
                            {% if current_manager.email.startswith('demo') %}
                                <span class="inline-block ml-2 px-2 py-1 text-xs bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-full">ДЕМО</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/logout" class="text-gray-500 hover:text-gray-700 text-sm">Выйти</a>
                <a href="/" class="text-[#0088CC] hover:text-[#006699] text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    На сайт
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <nav class="flex space-x-8" aria-label="Tabs">
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC] whitespace-nowrap tab-button active" href="#" data-page="dashboard">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L3 7v11h3v-6h8v6h3V7l-7-5z"/>
                    </svg>
                    Главная
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="clients">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    Клиенты
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="clients-count">{{ total_clients }}</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="presentations">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                        <path d="M16 5a1 1 0 011 1v8a1 1 0 01-1 1h-4V5h4z"/>
                    </svg>
                    Презентации
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="presentations-count">{{ presentations_count }}</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="saved-searches">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    Сохраненные поиски
                    <span class="ml-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="saved-searches-count" style="display: none;">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" href="{{ url_for('manager_favorites') }}">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                    </svg>
                    Избранное
                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="favorites-total-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" href="{{ url_for('manager_property_comparison') }}">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Сравнение
                    <span class="ml-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="comparison-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="applications">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4z" clip-rule="evenodd"/>
                    </svg>
                    Заявки
                    <span class="ml-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white text-xs px-2 py-1 rounded-full font-medium">{{ pending_applications_count }}</span>
                </a>
            </nav>
        </div>
    </div>
</div>

<!-- Main Content Area - Full Width -->
<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section (Default) -->
        <div class="content-section active" id="dashboard">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full mb-4" id="welcome-icon">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                    </div>
                    <div id="welcome-message-container">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2" id="welcome-title">Добро пожаловать, {{ current_manager.full_name.split()[0] }}!</h2>
                        <div id="welcome-messages" class="space-y-2 mb-6">
                            <p class="text-lg text-gray-600">Панель управления менеджера недвижимости</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-[#0088CC]">{{ total_clients }}</div>
                            <div class="text-sm text-gray-600">Клиентов</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-green-600">{{ collections_count }}</div>
                            <div class="text-sm text-gray-600">Подборок</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">{{ sent_collections_count }}</div>
                            <div class="text-sm text-gray-600">Отправлено</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">{{ pending_applications_count }}</div>
                            <div class="text-sm text-gray-600">Заявок</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Create Collection -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('create-collection')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Создать подборку</h3>
                            <p class="text-sm text-gray-600">Подберите недвижимость для клиента</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Нажмите для создания</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Manage Clients -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('clients')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Управление клиентами</h3>
                            <p class="text-sm text-gray-600">{{ total_clients }} активных клиентов</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Просмотр и добавление</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- View Collections -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('collections')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Мои подборки</h3>
                            <p class="text-sm text-gray-600">{{ collections_count }} созданных подборок</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Редактирование и отправка</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- New Favorite Properties -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('favorites')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Избранные объекты</h3>
                            <p class="text-sm text-gray-600"><span id="new-properties-count">0</span> сохраненных объектов</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Просмотр и экспорт</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- New Favorite Complexes -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('favorite-complexes')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Избранные ЖК</h3>
                            <p class="text-sm text-gray-600"><span id="new-complexes-count">0</span> жилых комплексов</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Просмотр и анализ</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- Property Comparison -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='/manager/property-comparison'">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Сравнение объектов</h3>
                            <p class="text-sm text-gray-600">Анализ и сравнение недвижимости</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">Создание подборок</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Последняя активность</h3>
                <div id="recent-recommendations" class="space-y-3">
                    <div class="text-gray-500 text-sm">Загрузка активности...</div>
                </div>
            </div>
        </div>

        <!-- Clients Section -->
        <div class="content-section" id="clients">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Управление клиентами</h3>
                    <button onclick="showAddClientModal()" class="bg-gradient-to-r from-[#0088CC] to-[#006699] hover:from-[#006699] hover:to-[#004466] text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Добавить клиента
                    </button>
                </div>
                
                <!-- Clients Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Телефон</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Create Collection Section -->
        <div class="content-section" id="create-collection">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Создать подборку недвижимости</h2>
                    
                    <!-- Collection Form -->
                    <form id="collection-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Название подборки</label>
                                <input type="text" id="collection-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="Введите название подборки">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Клиент</label>
                                <div class="flex space-x-2">
                                    <select id="collection-client" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="">Выберите клиента</option>
                                    </select>
                                    <button type="button" id="add-client-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm whitespace-nowrap">
                                        + Добавить
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Property Search Section -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Поиск недвижимости</h3>
                            <div class="space-y-4" id="property-search-container">
                                <!-- Основные фильтры -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Район</label>
                                        <select id="filter-district" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все районы</option>
                                            {% for district in districts %}
                                            <option value="{{ district }}">{{ district }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Застройщик</label>
                                        <select id="filter-developer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все застройщики</option>
                                            {% for developer in developers %}
                                            <option value="{{ developer }}">{{ developer }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Комнаты</label>
                                        <select id="filter-rooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Любое количество</option>
                                            <option value="студия">Студия</option>
                                            <option value="1">1 комната</option>
                                            <option value="2">2 комнаты</option>
                                            <option value="3">3 комнаты</option>
                                            <option value="4">4+ комнат</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Жилой комплекс</label>
                                        <select id="filter-complex" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">Все ЖК</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Цена и площадь -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена от</label>
                                        <input type="number" id="filter-price-min" placeholder="От, ₽" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена до</label>
                                        <input type="number" id="filter-price-max" placeholder="До, ₽" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Площадь от</label>
                                        <input type="number" id="filter-area-min" placeholder="От, м²" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Площадь до</label>
                                        <input type="number" id="filter-area-max" placeholder="До, м²" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                </div>

                                <!-- Дополнительные фильтры (скрытые по умолчанию) -->
                                <div class="border-t pt-4">
                                    <button id="toggle-advanced-filters" class="text-[#0088cc] hover:text-[#006699] text-sm font-medium mb-4">
                                        + Дополнительные фильтры
                                    </button>
                                    <div id="advanced-filters" class="manager-favorites-hidden space-y-4">
                                        <!-- Этажи и характеристики -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж от</label>
                                                <input type="number" id="filter-floor-min" placeholder="От" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж до</label>
                                                <input type="number" id="filter-floor-max" placeholder="До" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                                                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой статус</option>
                                                    <option value="строительство">Строительство</option>
                                                    <option value="сдан">Сдан</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Отделка</label>
                                                <select id="filter-finishing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любая отделка</option>
                                                    <option value="черновая">Черновая</option>
                                                    <option value="чистовая">Стандартная</option>
                                                    <option value="под ключ">Премиум</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Дополнительные характеристики -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Класс дома</label>
                                                <select id="filter-class" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой класс</option>
                                                    <option value="эконом">Эконом</option>
                                                    <option value="комфорт">Комфорт</option>
                                                    <option value="бизнес">Бизнес</option>
                                                    <option value="элитный">Элитный</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Материал стен</label>
                                                <select id="filter-material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">Любой материал</option>
                                                    <option value="кирпич">Кирпич</option>
                                                    <option value="монолит">Монолит</option>
                                                    <option value="панель">Панель</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Высота потолков от</label>
                                                <input type="number" id="filter-ceiling-min" placeholder="От, м" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Высота потолков до</label>
                                                <input type="number" id="filter-ceiling-max" placeholder="До, м" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                        </div>
                                        
                                        <!-- Удобства -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-balcony" class="mr-2 text-[#0088cc]">
                                                    Балкон/Лоджия
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-parking" class="mr-2 text-[#0088cc]">
                                                    Парковка
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-view" class="mr-2 text-[#0088cc]">
                                                    Красивый вид
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-penthouse" class="mr-2 text-[#0088cc]">
                                                    Пентхаус
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Ипотека -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-family-mortgage" class="mr-2 text-[#0088cc]">
                                                    Семейная ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-it-mortgage" class="mr-2 text-[#0088cc]">
                                                    IT ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-military-mortgage" class="mr-2 text-[#0088cc]">
                                                    Военная ипотека
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-rural-mortgage" class="mr-2 text-[#0088cc]">
                                                    Сельская ипотека
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Результаты поиска -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex items-center space-x-4">
                                            <h4 class="text-lg font-medium text-gray-800">Результаты поиска</h4>
                                            <span id="results-count" class="text-sm text-gray-500">0 квартир</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="saveCurrentSearch()" class="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                                <i class="fas fa-save"></i> Сохранить поиск
                                            </button>
                                            <button onclick="showSavedSearches()" class="px-3 py-2 bg-[#0088CC] text-white rounded text-sm hover:bg-[#006699]">
                                                <i class="fas fa-folder"></i> Сохранённые поиски
                                            </button>
                                        </div>
                                    </div>
                                        <div class="flex items-center space-x-3">
                                            <!-- View toggle -->
                                            <div class="flex border border-gray-300 rounded-lg">
                                                <button type="button" id="view-grid-btn" class="px-3 py-2 text-sm bg-[#0088cc] text-white rounded-l-lg">
                                                    <i class="fas fa-th"></i>
                                                </button>
                                                <button type="button" id="view-list-btn" class="px-3 py-2 text-sm bg-white text-gray-600 border-l border-gray-300 rounded-r-lg hover:bg-gray-50">
                                                    <i class="fas fa-list"></i>
                                                </button>
                                            </div>
                                            <button type="button" id="search-apartments-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                                Найти квартиры
                                            </button>
                                        </div>
                                    </div>
                                    <div id="properties-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>
                                    </div>
                                </div>

                                <!-- Выбранные объекты -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-lg font-medium text-gray-800">Выбранные объекты для подборки</h4>
                                        <span id="selected-count" class="text-sm text-gray-500">0 объектов</span>
                                    </div>
                                    <div id="selected-properties" class="space-y-3">
                                        <p class="text-gray-500 text-center py-4">Объекты не выбраны</p>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button type="button" id="clear-selection-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" disabled>
                                            Очистить выбор
                                        </button>
                                        <div class="space-x-3">
                                            <button type="button" id="save-collection-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" disabled>
                                                Сохранить подборку
                                            </button>
                                            <button type="button" id="send-collection-btn" class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors" disabled>
                                                Отправить клиенту
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Clients Section -->
            <div class="content-section" id="clients">
                <div class="bg-white rounded-xl shadow-sm p-1">
                    <div class="flex justify-between items-center mb-2 px-2 pt-2">
                        <h2 class="text-2xl font-bold text-gray-800">Управление клиентами</h2>
                        <button id="add-client-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                            <i class="fas fa-plus mr-2"></i>Добавить клиента
                        </button>
                    </div>
                    
                    <!-- Clients list -->
                    <div class="overflow-x-auto px-1">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Клиент</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Телефон</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Мои подборки</h2>
                            <button onclick="showSection('create-collection')" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать новую
                            </button>
                        </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="collections-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Загрузка подборок...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Presentations Section -->
            <div class="content-section" id="presentations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Presentations List View -->
                    <div id="presentations-list-view" class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Презентации</h2>
                            <button onclick="showCreatePresentationModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать презентацию
                            </button>
                        </div>
                        
                        <!-- Presentations Grid -->
                        <div id="presentations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="text-center py-8 col-span-full">
                                <p class="text-gray-500">Загрузка презентаций...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Presentation Viewer (Hidden by default) -->
                    <div id="presentation-viewer" class="hidden bg-white rounded-xl shadow-sm p-6">
                        <!-- Back to list button -->
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="showPresentationsList()" class="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>
                                Назад к списку
                            </button>
                            <div id="presentation-viewer-actions" class="flex space-x-3">
                                <!-- Actions will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Presentation content will be loaded here -->
                        <div id="presentation-content">
                            <div class="text-center py-8">
                                <p class="text-gray-500">Загрузка презентации...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Рекомендации клиентам</h2>
                        <div class="flex gap-2">
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                <i class="fas fa-sync mr-2"></i>
                                Обновить
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-paper-plane text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Отправлено</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-sent">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-eye text-2xl text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Просмотрено</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-viewed">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-heart text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Заинтересованы</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-interested">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-calendar text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">Просмотры назначены</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-scheduled">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <select id="rec-filter-client" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все клиенты</option>
                            </select>
                            <select id="rec-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все статусы</option>
                                <option value="sent">Отправлено</option>
                                <option value="viewed">Просмотрено</option>
                                <option value="interested">Заинтересованы</option>
                                <option value="not_interested">Не заинтересованы</option>
                                <option value="scheduled_viewing">Просмотр назначен</option>
                            </select>
                            <select id="rec-filter-type" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все типы</option>
                                <option value="property">Квартиры</option>
                                <option value="complex">ЖК</option>
                            </select>
                            <select id="rec-filter-priority" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">Все приоритеты</option>
                                <option value="urgent">Срочно</option>
                                <option value="high">Высокий</option>
                                <option value="normal">Обычный</option>
                            </select>
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                Применить фильтры
                            </button>
                        </div>
                    </div>

                    <!-- Recommendations List -->
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>Загрузка рекомендаций...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Saved Searches Section -->
            <div class="content-section" id="saved-searches">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Сохранённые поиски</h2>
                        <div class="flex space-x-3">
                            <button onclick="createNewSearch()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Создать поиск
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="saved-searches-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Загрузка сохранённых поисков...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Мои подборки</h2>
                    <div id="collections-container" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">Загрузка подборок...</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Рекомендации клиентам</h2>
                        <div class="flex space-x-2">
                            <select id="recommendations-client-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Все клиенты</option>
                            </select>
                            <select id="recommendations-status-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Все статусы</option>
                                <option value="sent">Отправлено</option>
                                <option value="viewed">Просмотрено</option>
                                <option value="interested">Заинтересованы</option>
                                <option value="not_interested">Не заинтересованы</option>
                                <option value="scheduled_viewing">Просмотр назначен</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Stats cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-gray-900" id="recommendations-sent">0</div>
                            <div class="text-sm text-gray-600">Отправлено</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600" id="recommendations-viewed">0</div>
                            <div class="text-sm text-gray-600">Просмотрено</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-purple-600" id="recommendations-interested">0</div>
                            <div class="text-sm text-gray-600">Заинтересованы</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-orange-600" id="recommendations-scheduled">0</div>
                            <div class="text-sm text-gray-600">Просмотры назначены</div>
                        </div>
                    </div>
                    
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">Загрузка рекомендаций...</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Applications Section -->
            <div class="content-section" id="applications">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Заявки на кешбек</h2>
                    
                    <!-- Filter tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button class="application-tab active border-b-2 border-[#0088cc] py-2 px-1 text-sm font-medium text-[#0088cc]" data-status="all">
                                Все заявки
                            </button>
                            <button class="application-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700" data-status="pending">
                                На рассмотрении
                            </button>
                            <button class="application-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700" data-status="approved">
                                Одобрены
                            </button>
                            <button class="application-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700" data-status="rejected">
                                Отклонены
                            </button>
                        </nav>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Клиент</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Объект</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Сумма кешбека</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="applications-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">Загрузка заявок...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

           

            <!-- Combined Favorites Section -->
            <div class="content-section" id="favorites">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <!-- Main Header -->
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                    <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    Избранное
                                    <span class="bg-red-500 text-white px-3 py-1 rounded-full text-lg font-medium ml-2" id="favorites-total-count">0</span>
                                </h2>
                                <p class="text-gray-600 mt-1">Сохраненные объекты и жилые комплексы</p>
                            </div>
                        </div>

                        <!-- Internal Horizontal Tabs -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm favorites-tab-button active" data-tab="properties">
                                    <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    Избранные объекты
                                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="favorites-properties-count">0</span>
                                </button>
                                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm favorites-tab-button" data-tab="complexes">
                                    <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    Избранные ЖК
                                    <span class="ml-2 bg-gradient-to-r from-pink-500 to-pink-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="favorites-complexes-count">0</span>
                                </button>
                            </nav>
                        </div>

                        <!-- Properties Tab Content -->
                        <div id="favorites-properties-tab" class="favorites-tab-content active">
                            <!-- Properties Empty State -->
                            <div id="empty-properties" class="text-center py-12">
                                <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                                    <svg class="w-full h-full" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                </div>
                                <p class="text-gray-500 text-lg mb-4">У вас пока нет избранных объектов</p>
                                <p class="text-gray-400 text-sm">Добавьте объекты в избранное для быстрого доступа к ним</p>
                            </div>

                            <!-- Properties Grid -->
                            <div id="properties-container" class="manager-favorites-hidden">
                                <div id="properties-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Property cards will be inserted here by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Complexes Tab Content -->
                        <div id="favorites-complexes-tab" class="favorites-tab-content">
                            <!-- Complexes Empty State -->
                            <div id="empty-complexes" class="text-center py-12">
                                <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                                    <svg class="w-full h-full" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-gray-500 text-lg mb-4">У вас пока нет избранных ЖК</p>
                                <p class="text-gray-400 text-sm">Добавьте жилые комплексы в избранное для отслеживания новых предложений</p>
                            </div>

                            <!-- Complexes Grid -->
                            <div id="favorite-complexes-container">
                                <div id="favorite-complexes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Complex cards will be inserted here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// IMMEDIATELY DEFINE CRITICAL FUNCTIONS AT TOP
console.log('🚀 Defining critical functions FIRST...');

// Internal favorites tabs functionality
function switchFavoriteTab(tabName) {
    console.log('🔄 Switching favorites tab to:', tabName);
    
    // Update tab buttons
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    tabButtons.forEach(button => {
        const isActive = button.dataset.tab === tabName;
        button.classList.toggle('active', isActive);
    });
    
    // Update tab content
    const tabContents = document.querySelectorAll('.favorites-tab-content');
    tabContents.forEach(content => {
        const isActive = content.id === `favorites-${tabName}-tab`;
        content.classList.toggle('active', isActive);
        content.classList.toggle('hidden', !isActive);
    });
    
    // Load content based on tab
    if (tabName === 'properties' && document.getElementById('properties-grid').children.length === 0) {
        loadFavoriteProperties();
    } else if (tabName === 'complexes' && document.getElementById('favorite-complexes-grid').children.length === 0) {
        loadFavoriteComplexes();
    }
    
    console.log('✅ Switched to', tabName, 'tab');
}

// Add event listeners for internal tabs
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            switchFavoriteTab(this.dataset.tab);
        });
    });
});

// Define loadClients function IMMEDIATELY
window.loadClients = function() {
    console.log('🔄 Loading clients NOW...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('❌ clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td></tr>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('📡 Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Clients data received:', data);
            if (data.success) {
                console.log('✅ Success! Displaying', data.clients.length, 'clients');
                
                // Update clients count in tab
                const clientsCountElement = document.getElementById('clients-count');
                if (clientsCountElement) {
                    clientsCountElement.textContent = data.clients.length;
                    console.log('✅ Updated clients count to:', data.clients.length);
                }
                
                const tbody = document.getElementById('clients-table-body');
                if (!data.clients || data.clients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Клиенты не найдены</td></tr>';
                } else {
                    tbody.innerHTML = data.clients.map(client => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${client.full_name || 'Не указано'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || 'Не указано'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    Активен
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">Редактировать</button>
                                <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">Удалить</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } else {
                console.error('❌ API returned error:', data.error);
                tableBody.innerHTML = 
                    `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading clients:', error);
            tableBody.innerHTML = 
                '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка загрузки клиентов</td></tr>';
        });
};

console.log('✅ loadClients function defined at top:', typeof window.loadClients);

// Define loadRecommendations function IMMEDIATELY
window.loadRecommendations = function() {
    console.log('🔄 Loading recommendations NOW...');
    const container = document.getElementById('recommendations-container');
    
    if (!container) {
        console.error('❌ recommendations-container not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-8 text-gray-500">Загрузка рекомендаций...</div>';
    
    fetch('/api/manager/recommendations')
        .then(response => {
            console.log('📡 Recommendations response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Recommendations data received:', data);
            if (data.success) {
                console.log('✅ Success! Found', data.recommendations.length, 'recommendations');
                
                // Update recommendations count in tab
                const recommendationsCountElement = document.getElementById('recommendations-count');
                if (recommendationsCountElement) {
                    recommendationsCountElement.textContent = data.recommendations.length;
                    console.log('✅ Updated recommendations count to:', data.recommendations.length);
                }
                
                // Update stats
                if (data.stats) {
                    document.getElementById('recommendations-sent').textContent = data.stats.sent || 0;
                    document.getElementById('recommendations-viewed').textContent = data.stats.viewed || 0;
                    document.getElementById('recommendations-interested').textContent = data.stats.interested || 0;
                    document.getElementById('recommendations-scheduled').textContent = data.stats.scheduled || 0;
                }
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Рекомендации не найдены</div>';
                } else {
                    container.innerHTML = data.recommendations.map(rec => `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-medium text-gray-900">${rec.property_title || rec.title || 'Объект недвижимости'}</h4>
                                    <p class="text-sm text-gray-600">Клиент: ${rec.client_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${rec.status || 'Отправлено'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${rec.message || 'Рекомендация отправлена'}</p>
                            <div class="text-xs text-gray-500">
                                Отправлено: ${new Date(rec.created_at || rec.sent_at).toLocaleDateString('ru-RU')}
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                console.error('❌ API returned error:', data.error);
                container.innerHTML = `<div class="text-center py-8 text-red-500">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading recommendations:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
        });
};

console.log('✅ loadRecommendations function defined at top:', typeof window.loadRecommendations);

// Define loadManagerSavedSearches function IMMEDIATELY  
window.loadManagerSavedSearches = function() {
    console.log('🔄 Loading manager saved searches NOW...');
    const container = document.getElementById('saved-searches-grid');
    
    if (!container) {
        console.error('❌ saved-searches-grid not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Загрузка сохранённых поисков...</p></div>';
    
    fetch('/api/manager/saved-searches')
        .then(response => {
            console.log('📡 Saved searches response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Saved searches data received:', data);
            if (data.success) {
                console.log('✅ Success! Found', data.searches.length, 'saved searches');
                
                if (!data.searches || data.searches.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <div class="text-gray-400 mb-4">
                                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-lg">Сохранённые поиски не найдены</p>
                            <p class="text-gray-400 text-sm mt-2">Создайте поиск на странице "Недвижимость" и сохраните его</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.searches.map(search => {
                        // Parse filters to get meaningful description
                        let filtersDescription = 'Все объекты';
                        let activeFiltersCount = 0;
                        
                        if (search.additional_filters) {
                            try {
                                const filters = JSON.parse(search.additional_filters);
                                const parts = [];
                                
                                if (filters.rooms && filters.rooms.length > 0) {
                                    parts.push(filters.rooms.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (filters.priceFrom || filters.priceTo) {
                                    const from = filters.priceFrom || '0';
                                    const to = filters.priceTo || '∞';
                                    parts.push(`${from}-${to} млн`);
                                    activeFiltersCount++;
                                }
                                
                                if (filters.districts && filters.districts.length > 0) {
                                    parts.push(filters.districts.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (filters.developers && filters.developers.length > 0) {
                                    parts.push(filters.developers.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (parts.length > 0) {
                                    filtersDescription = parts.join(' • ');
                                }
                            } catch (e) {
                                console.error('Error parsing filters:', e);
                            }
                        }
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="font-medium text-gray-900 mb-1">${search.name || 'Без названия'}</h3>
                                        <p class="text-sm text-gray-600">${filtersDescription}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-50 text-blue-700 border border-blue-200">
                                        ${activeFiltersCount} ${activeFiltersCount === 1 ? 'фильтр' : activeFiltersCount < 5 ? 'фильтра' : 'фильтров'}
                                    </span>
                                </div>
                                
                                <div class="text-xs text-gray-500 mb-3">
                                    ${new Date(search.created_at).toLocaleDateString('ru-RU')}
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="viewSearch(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white rounded text-sm hover:bg-[#006699] transition-colors">
                                        Просмотр
                                    </button>
                                    <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                                        Отправить
                                    </button>
                                    <button onclick="deleteSearch(${search.id})" class="px-3 py-2 bg-gray-100 text-gray-600 rounded text-sm hover:bg-red-50 hover:text-red-600 transition-colors">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zM8 11a1 1 0 102 0v2a1 1 0 11-2 0v-2zm4 0a1 1 0 102 0v2a1 1 0 11-2 0v-2z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } else {
                console.error('❌ API returned error:', data.error);
                container.innerHTML = `<div class="text-center py-8 col-span-full"><p class="text-red-500">Ошибка: ${data.error}</p></div>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading saved searches:', error);
            container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-red-500">Ошибка загрузки сохранённых поисков</p></div>';
        });
};

console.log('✅ loadManagerSavedSearches function defined at top:', typeof window.loadManagerSavedSearches);

// Define missing functions for saved searches
window.viewSearch = function(searchId) {
    console.log('🔍 View search:', searchId);
    
    // Find the search data to extract filters
    fetch(`/api/manager/saved-searches`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const search = data.searches.find(s => s.id === searchId);
                if (search && search.additional_filters) {
                    try {
                        const filters = JSON.parse(search.additional_filters);
                        
                        // Build URL parameters from filters
                        const params = new URLSearchParams();
                        
                        if (filters.rooms && filters.rooms.length > 0) {
                            params.append('rooms', filters.rooms.join(','));
                        }
                        if (filters.districts && filters.districts.length > 0) {
                            params.append('district', filters.districts.join(','));
                        }
                        if (filters.developers && filters.developers.length > 0) {
                            params.append('developer', filters.developers.join(','));
                        }
                        if (filters.priceFrom && filters.priceFrom !== '') {
                            // Convert millions to rubles (multiply by 1,000,000)
                            const priceFromRubles = parseFloat(filters.priceFrom) * 1000000;
                            params.append('price_min', priceFromRubles.toString());
                        }
                        if (filters.priceTo && filters.priceTo !== '') {
                            // Convert millions to rubles (multiply by 1,000,000)
                            const priceToRubles = parseFloat(filters.priceTo) * 1000000;
                            params.append('price_max', priceToRubles.toString());
                        }
                        if (filters.areaFrom && filters.areaFrom !== '') {
                            params.append('area_min', filters.areaFrom);
                        }
                        if (filters.areaTo && filters.areaTo !== '') {
                            params.append('area_max', filters.areaTo);
                        }
                        
                        const url = `/properties?${params.toString()}`;
                        console.log('🔍 Opening search with filters:', url);
                        window.open(url, '_blank');
                    } catch (e) {
                        console.error('Error parsing filters:', e);
                        window.open(`/properties`, '_blank');
                    }
                } else {
                    window.open(`/properties`, '_blank');
                }
            }
        })
        .catch(error => {
            console.error('Error loading search filters:', error);
            window.open(`/properties`, '_blank');
        });
};

window.sendSearchToClient = function(searchId) {
    console.log('📧 Send search to client:', searchId);
    
    // Show client selection modal
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Отправить поиск клиенту</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                        <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]">
                            <option value="">Загрузка клиентов...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Сообщение (необязательно)</label>
                        <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]" placeholder="Добавьте персональное сообщение..."></textarea>
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="closeSendSearchModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="flex-1 px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699]">
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients for selection
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('client-select');
                select.innerHTML = '<option value="">Выберите клиента</option>' + 
                    data.clients.map(client => 
                        `<option value="${client.id}">${client.full_name} (${client.email})</option>`
                    ).join('');
            }
        });
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value;
    
    if (!clientId) {
        alert('Пожалуйста, выберите клиента');
        return;
    }
    
    fetch('/api/manager/send-search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            search_id: searchId,
            client_id: clientId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Поиск успешно отправлен клиенту!');
            closeSendSearchModal();
        } else {
            alert('Ошибка при отправке: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error sending search:', error);
        alert('Ошибка при отправке поиска');
    });
};

window.deleteSearch = function(searchId) {
    if (!confirm('Вы уверены, что хотите удалить этот сохранённый поиск?')) {
        return;
    }
    
    fetch(`/api/manager/saved-searches/${searchId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Поиск успешно удалён!');
            // Reload saved searches
            loadManagerSavedSearches();
        } else {
            alert('Ошибка при удалении: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error deleting search:', error);
        alert('Ошибка при удалении поиска');
    });
};

console.log('✅ Saved searches functions defined');

// Navigation functionality - Global scope
window.showSection = function(sectionId) {
    console.log('🎯 showSection called with:', sectionId);
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
        tab.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
        tab.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        console.log('✅ Section activated:', sectionId);
    } else {
        console.error('❌ Section not found:', sectionId);
    }
    
    // Add active class to corresponding tab button
    const activeTab = document.querySelector(`[data-page="${sectionId}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.classList.remove('border-transparent', 'text-gray-500');
        activeTab.classList.add('border-[#0088CC]', 'text-[#0088CC]');
    }
    
    // Load section-specific data
    if (sectionId === 'clients') {
        console.log('🎯 Clients section selected - calling loadClients');
        if (typeof window.loadClients === 'function') {
            window.loadClients();
        } else {
            console.error('❌ window.loadClients is not a function');
        }
    } else if (sectionId === 'collections') {
        loadCollections();
    } else if (sectionId === 'saved-searches') {
        loadManagerSavedSearches();
    } else if (sectionId === 'applications') {
        loadApplications();
    } else if (sectionId === 'presentations') {
        console.log('🎯 Presentations section selected - calling loadPresentations');
        if (typeof window.loadPresentations === 'function') {
            window.loadPresentations();
        } else if (typeof loadPresentations === 'function') {
            loadPresentations();
        } else {
            console.error('❌ loadPresentations function not found');
        }
    } else if (sectionId === 'recommendations') {
        console.log('🎯 Recommendations section selected - calling loadRecommendations');
        if (typeof window.loadRecommendations === 'function') {
            window.loadRecommendations();
        } else {
            console.error('❌ window.loadRecommendations is not a function');
        }
    } else if (sectionId === 'favorites') {
        console.log('🎯 Favorite properties section selected - calling loadFavoriteProperties');
        if (typeof window.loadFavoriteProperties === 'function') {
            window.loadFavoriteProperties();
        } else {
            console.error('❌ window.loadFavoriteProperties is not a function');
        }
        
        // Also trigger count update to sync UI
        updateFavoritesCounts();
    } else if (sectionId === 'favorite-complexes') {
        console.log('🎯 Favorite complexes section selected - calling loadFavoriteComplexes');
        if (typeof window.loadFavoriteComplexes === 'function') {
            window.loadFavoriteComplexes();
        } else {
            console.error('❌ window.loadFavoriteComplexes is not a function');
        }
        
        // Also trigger count update to sync UI
        updateFavoritesCounts();
    } else if (sectionId === 'overview' || sectionId === 'dashboard') {
        console.log('🎯 Dashboard overview selected - loading recent recommendations');
        if (typeof window.loadRecentRecommendations === 'function') {
            window.loadRecentRecommendations();
        } else {
            console.error('❌ window.loadRecentRecommendations is not a function');
        }
        // Reload welcome message when returning to overview
        if (typeof window.loadWelcomeMessage === 'function') {
            window.loadWelcomeMessage();
        }
    }
}

// Add click handlers to tab buttons  
document.querySelectorAll('.tab-button[data-page]').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const page = e.currentTarget.dataset.page;
        if (page) {
            window.showSection(page);
        }
    });
});

// Alias for backward compatibility
window.switchToSection = window.showSection;

// User menu toggle (only if element exists)
const userMenuButton = document.getElementById('user-menu-button');
if (userMenuButton) {
    userMenuButton.addEventListener('click', function() {
        const menu = document.getElementById('user-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    });
}

// Property search functionality - Make functions global
let selectedProperties = [];
let currentView = 'grid'; // grid or list
let collections = [];
let complexes = {};

// Global functions
window.searchApartments = function() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const complex = document.getElementById('filter-complex').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    const areaMin = document.getElementById('filter-area-min').value;
    const areaMax = document.getElementById('filter-area-max').value;
    const floorMin = document.getElementById('filter-floor-min').value;
    const floorMax = document.getElementById('filter-floor-max').value;
    const status = document.getElementById('filter-status').value;
    const finishing = document.getElementById('filter-finishing').value;
    
    const searchParams = new URLSearchParams();
    if (district) searchParams.append('district', district);
    if (developer) searchParams.append('developer', developer);
    if (rooms) searchParams.append('rooms', rooms);
    if (complex) searchParams.append('complex', complex);
    if (priceMin) searchParams.append('price_min', priceMin);
    if (priceMax) searchParams.append('price_max', priceMax);
    if (areaMin) searchParams.append('area_min', areaMin);
    if (areaMax) searchParams.append('area_max', areaMax);
    if (floorMin) searchParams.append('floor_min', floorMin);
    if (floorMax) searchParams.append('floor_max', floorMax);
    if (status) searchParams.append('status', status);
    if (finishing) searchParams.append('finishing', finishing);
    
    // Show loading state
    document.getElementById('properties-results').innerHTML = 
        '<p class="text-gray-500 col-span-full text-center py-8">Поиск квартир...</p>';
    
    // Load the EXACT same data that properties.html uses
    console.log('Loading properties using same method as properties.html...');
    
    // First try to get the data from the same endpoint properties.html uses
    fetch('/properties')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract the allProperties array from the script tag
            const scriptTags = doc.querySelectorAll('script');
            let allProperties = [];
            
            for (let script of scriptTags) {
                if (script.textContent.includes('let allProperties = ')) {
                    const match = script.textContent.match(/let allProperties = (\[.*?\]);/s);
                    if (match) {
                        try {
                            allProperties = JSON.parse(match[1]);
                            console.log('Successfully extracted properties from properties.html:', allProperties.length);
                            break;
                        } catch (e) {
                            console.error('Failed to parse properties from properties.html:', e);
                        }
                    }
                }
            }
            
            if (allProperties.length === 0) {
                console.log('Could not extract from properties.html, trying JSON endpoint...');
                return fetch('/data/properties_expanded.json').then(r => r.json());
            }
            
            return allProperties;
        })
        .then(allProperties => {
            console.log('Final properties data:', allProperties.length);
            console.log('Sample property:', allProperties[0]);
            
            // Apply filtering exactly like properties.html
            let filteredProperties = allProperties.filter(property => {
                // District filter
                if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
                    return false;
                }
                
                // Developer filter
                if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
                    return false;
                }
                
                // Rooms filter - exactly like properties.html
                if (rooms) {
                    const propertyType = property.type || '';
                    const propertyRooms = property.rooms || 0;
                    
                    if (rooms === 'студия' && propertyType !== 'студия') return false;
                    if (rooms === '1' && propertyRooms !== 1) return false;
                    if (rooms === '2' && propertyRooms !== 2) return false;
                    if (rooms === '3' && propertyRooms !== 3) return false;
                    if (rooms === '4+' && propertyRooms < 4 && propertyType !== 'дом') return false;
                }
                
                // Complex filter (ЖК filter)
                if (complex && complex !== 'Все ЖК' && property.complex_name && !property.complex_name.toLowerCase().includes(complex.toLowerCase())) {
                    return false;
                }
                
                // Price filter (in millions like properties.html)
                if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
                if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
                
                // Area filter
                if (areaMin && property.area < parseFloat(areaMin)) return false;
                if (areaMax && property.area > parseFloat(areaMax)) return false;
                
                // Floor filter
                if (floorMin && property.floor < parseInt(floorMin)) return false;
                if (floorMax && property.floor > parseInt(floorMax)) return false;
                
                return true;
            });
            
            console.log('Filtered properties:', filteredProperties.length);
            
            // Show filtered results - limit to 20 for performance
            const displayProps = filteredProperties.slice(0, 20);
            displayApartments(displayProps);
            document.getElementById('results-count').textContent = `${filteredProperties.length} квартир (показано ${displayProps.length})`;
        })
        .catch(error => {
            console.error('Error loading properties:', error);
            document.getElementById('properties-results').innerHTML = 
                '<p class="text-red-500 col-span-full text-center py-8">Ошибка загрузки данных</p>';
            document.getElementById('results-count').textContent = '0 квартир';
        });
}

function filterProperties(properties, filters) {
    const { 
        district, developer, rooms, complex, priceMin, priceMax, areaMin, areaMax, 
        floorMin, floorMax, status, finishing, buildingClass, material, ceilingMin, ceilingMax,
        hasBalcony, hasParking, hasView, isPenthouse, familyMortgage, itMortgage, militaryMortgage, ruralMortgage
    } = filters;
    
    return properties.filter(property => {
        // District filter
        if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
            return false;
        }
        
        // Rooms filter - fix to match property data structure
        if (rooms) {
            const propertyType = property.type || '';
            const propertyRooms = property.rooms || 0;
            
            if (rooms === 'студия' && propertyType !== 'студия') return false;
            if (rooms === '1' && propertyRooms !== 1) return false;
            if (rooms === '2' && propertyRooms !== 2) return false;
            if (rooms === '3' && propertyRooms !== 3) return false;
            if (rooms === '4+' && propertyRooms < 4 && propertyType !== 'дом') return false;
        }
        
        // Complex filter
        if (complex && property.complex_id && property.complex_id != complex) {
            return false;
        }
        
        // Price filter (in millions)
        if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
        if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
        
        // Area filter
        if (areaMin && property.area < parseFloat(areaMin)) return false;
        if (areaMax && property.area > parseFloat(areaMax)) return false;
        
        // Floor filter
        if (floorMin && property.floor < parseInt(floorMin)) return false;
        if (floorMax && property.floor > parseInt(floorMax)) return false;
        
        // Status filter
        if (status) {
            const completionDate = property.completion_date || '';
            if (status === 'сдан' && !completionDate.toLowerCase().includes('сдан')) return false;
            if (status === 'строительство' && completionDate.toLowerCase().includes('сдан')) return false;
        }
        
        // Finishing filter  
        if (finishing) {
            const finishType = property.finish_type || '';
            if (finishing === 'черновая' && !finishType.toLowerCase().includes('черновая')) return false;
            if (finishing === 'чистовая' && !finishType.toLowerCase().includes('чистовая')) return false;
            if (finishing === 'под ключ' && !finishType.toLowerCase().includes('премиум')) return false;
        }
        
        // Building class filter
        if (buildingClass && property.building_class && !property.building_class.toLowerCase().includes(buildingClass.toLowerCase())) {
            return false;
        }
        
        // Material filter
        if (material && property.wall_material && !property.wall_material.toLowerCase().includes(material.toLowerCase())) {
            return false;
        }
        
        // Ceiling height filter
        if (ceilingMin && property.ceiling_height && property.ceiling_height < parseFloat(ceilingMin)) return false;
        if (ceilingMax && property.ceiling_height && property.ceiling_height > parseFloat(ceilingMax)) return false;
        
        // Amenities filters
        if (hasBalcony && !property.has_balcony) return false;
        if (hasParking && !property.has_parking) return false;
        if (hasView && !property.has_view) return false;
        if (isPenthouse && !property.is_penthouse) return false;
        
        // Mortgage filters
        if (familyMortgage && !property.family_mortgage) return false;
        if (itMortgage && !property.it_mortgage) return false;
        if (militaryMortgage && !property.military_mortgage) return false;
        if (ruralMortgage && !property.rural_mortgage) return false;
        
        return true;
    });
}

function displayApartments(apartments) {
    const container = document.getElementById('properties-results');
    
    if (apartments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Квартиры не найдены</p>';
        return;
    }
    
    if (currentView === 'grid') {
        // Grid view
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
        container.innerHTML = apartments.map(apartment => {
            const images = apartment.gallery || [apartment.image] || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=300&q=80';
            const cashback = Math.round(apartment.price * 0.05); // 5% cashback
            
            return `
                <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="relative">
                        <img src="${mainImage}" alt="${apartment.title || apartment.complex_name}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium">
                            Кешбэк ₽${(cashback / 1000000).toFixed(1)}М
                        </div>
                        <div class="absolute bottom-2 left-2 bg-white px-2 py-1 rounded text-xs font-medium">
                            ${apartment.rooms === 0 ? 'Студия' : apartment.rooms + '-комн.'}
                        </div>
                    </div>
                    <div class="p-4">
                        <h5 class="font-medium text-gray-900 mb-1">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                        <p class="text-sm text-gray-600 mb-2">${apartment.district} • ${apartment.developer}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">${apartment.area} м²</span>
                            <span class="text-xs text-gray-500">${apartment.floor}/${apartment.total_floors || apartment.max_floor || 'Н/Д'} этаж</span>
                        </div>
                        <p class="text-lg font-bold text-[#0088cc] mb-2">₽${apartment.price?.toLocaleString() || 'Цена по запросу'}</p>
                        <p class="text-sm text-green-600 mb-3">Кешбек: ₽${cashback.toLocaleString()}</p>
                        <div class="flex gap-2">
                            <button onclick="viewProperty(${apartment.id})" class="flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                Подробнее
                            </button>
                            <button onclick="selectProperty(${apartment.id})" class="flex-1 px-3 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                ${selectedProperties.includes(apartment.id) ? 'Добавлено ✓' : 'Добавить в подборку'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        // List view
        container.className = 'space-y-4';
        container.innerHTML = apartments.map(apartment => {
            const complex = complexes[apartment.complex_id] || {};
            const images = apartment.images || complex.images || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=150&q=80';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="flex gap-4">
                        <img src="${mainImage}" alt="${apartment.complex_name}" class="w-32 h-24 object-cover rounded flex-shrink-0">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-medium text-gray-900">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                                    <p class="text-sm text-gray-600">${apartment.district} • ${apartment.developer}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-[#0088cc]">${apartment.price.toLocaleString()} ₽</p>
                                    <p class="text-sm text-green-600">Кешбек: ${apartment.cashback.toLocaleString()} ₽</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-4 text-sm text-gray-500">
                                    <span>${apartment.type === 'студия' ? 'Студия' : apartment.rooms + '-комн.'}</span>
                                    <span>${apartment.area} м²</span>
                                    <span>${apartment.floor}/${apartment.max_floor} этаж</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewProperty(${apartment.id})" class="px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                        Подробнее
                                    </button>
                                    <button onclick="selectProperty(${apartment.id})" class="px-4 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                        ${selectedProperties.includes(apartment.id) ? 'Добавлено ✓' : 'Добавить в подборку'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

// Make all functions global
window.selectProperty = function(propertyId) {
    // Toggle selection
    if (selectedProperties.includes(propertyId)) {
        // Remove from selection
        const index = selectedProperties.indexOf(propertyId);
        selectedProperties.splice(index, 1);
    } else {
        // Add to selection
        selectedProperties.push(propertyId);
    }
    
    updateSelectedProperties();
    updateButtons();
    
    // Update visual state in search results
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer) {
        searchApartments(); // Refresh to update visual state
    }
}

window.updateSelectedProperties = function() {
    const container = document.getElementById('selected-properties');
    const countElement = document.getElementById('selected-count');
    
    countElement.textContent = `${selectedProperties.length} объектов`;
    
    if (selectedProperties.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Объекты не выбраны</p>';
        return;
    }
    
    // Fetch selected properties details
    Promise.all(selectedProperties.map(id => 
        fetch(`/api/properties/${id}`).then(r => r.json())
    )).then(responses => {
        const totalCashback = responses.reduce((sum, response) => {
            return sum + (response.success ? response.property.cashback : 0);
        }, 0);
        
        container.innerHTML = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-blue-900">Общий кешбек по подборке:</span>
                    <span class="text-xl font-bold text-blue-900">${totalCashback.toLocaleString()} ₽</span>
                </div>
            </div>
        ` + responses.map((response, index) => {
            if (!response.success) return '';
            const property = response.property;
            return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                    <div class="flex-1">
                        <h6 class="font-medium">${property.complex_name}</h6>
                        <p class="text-sm text-gray-600">${property.district} • ${property.developer}</p>
                        <p class="text-sm text-gray-600">${property.rooms}-комн. • ${property.area} м² • ${property.price.toLocaleString()} ₽</p>
                        <p class="text-sm text-green-600">Кешбек: ${property.cashback.toLocaleString()} ₽</p>
                    </div>
                    <button onclick="removeProperty(${index})" class="ml-3 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    });
}

window.updateButtons = function() {
    const hasSelection = selectedProperties.length > 0;
    document.getElementById('save-collection-btn').disabled = !hasSelection;
    document.getElementById('send-collection-btn').disabled = !hasSelection;
    document.getElementById('clear-selection-btn').disabled = !hasSelection;
}

window.removeProperty = function(index) {
    selectedProperties.splice(index, 1);
    updateSelectedProperties();
    updateButtons();
    
    // Refresh search results to update visual state
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>') {
        searchApartments();
    }
}

// Save search with client-compatible format
window.saveCurrentSearch = function() {
    openSaveSearchModal();
};

// Create save search modal
function openSaveSearchModal() {
    const modalHTML = `
        <div id="save-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Сохранить поиск</h3>
                <form id="save-search-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Название поиска</label>
                        <input type="text" id="manager-search-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="Например: 2-комн в центре до 10млн">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email клиента</label>
                        <input type="email" id="manager-client-email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="client@example.com">
                        <p class="text-xs text-gray-500 mt-1">Если указан, поиск будет отправлен клиенту и сохранён в его аккаунте</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                        <textarea id="manager-search-description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                                  placeholder="Дополнительные заметки о поиске"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeSaveSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                            Отмена
                        </button>
                        <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Auto-generate search name
    generateManagerSearchName();
    
    // Bind events
    document.getElementById('save-search-form').addEventListener('submit', handleSaveSearch);
}

function generateManagerSearchName() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    
    let name = 'Поиск ';
    if (rooms) name += rooms + ' ';
    if (district) name += 'в ' + district + ' ';
    if (developer) name += 'от ' + developer + ' ';
    if (priceMin || priceMax) {
        name += `${priceMin || '0'}-${priceMax || '∞'} млн`;
    }
    
    document.getElementById('manager-search-name').value = name.trim() || 'Мой поиск';
}

function closeSaveSearchModal() {
    const modal = document.getElementById('save-search-modal');
    if (modal) modal.remove();
}

async function handleSaveSearch(e) {
    e.preventDefault();
    
    const searchName = document.getElementById('manager-search-name').value.trim();
    const clientEmail = document.getElementById('manager-client-email').value.trim();
    const description = document.getElementById('manager-search-description').value.trim();
    
    if (!searchName) {
        alert('Введите название поиска');
        return;
    }
    
    // Convert manager filters to client-compatible format
    const clientFilters = convertManagerFiltersToClient();
    
    const searchData = {
        name: searchName,
        description: description,
        client_email: clientEmail,
        notify_new_matches: true,
        search_type: 'properties',
        ...clientFilters
    };
    
    try {
        const response = await fetch('/api/searches', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(searchData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeSaveSearchModal();
            if (clientEmail) {
                alert(`Поиск успешно сохранён и отправлен клиенту на ${clientEmail}!`);
            } else {
                alert('Поиск успешно сохранён!');
            }
        } else {
            alert('Ошибка при сохранении поиска: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('Ошибка при сохранении поиска');
    }
}

// Convert manager filters to client-compatible format
function convertManagerFiltersToClient() {
    return {
        // Basic filters
        location: document.getElementById('filter-district').value || '',
        developer: document.getElementById('filter-developer').value || '',
        property_type: document.getElementById('filter-rooms').value || '',
        complex_name: document.getElementById('filter-complex').value || '',
        
        // Price (convert to client format)
        price_min: document.getElementById('filter-price-min').value ? 
                   parseFloat(document.getElementById('filter-price-min').value) * 1000000 : null,
        price_max: document.getElementById('filter-price-max').value ? 
                   parseFloat(document.getElementById('filter-price-max').value) * 1000000 : null,
        
        // Size
        size_min: document.getElementById('filter-area-min').value ? 
                  parseFloat(document.getElementById('filter-area-min').value) : null,
        size_max: document.getElementById('filter-area-max').value ? 
                  parseFloat(document.getElementById('filter-area-max').value) : null,
        
        // Floor
        floor_min: document.getElementById('filter-floor-min').value ? 
                   parseInt(document.getElementById('filter-floor-min').value) : null,
        floor_max: document.getElementById('filter-floor-max').value ? 
                   parseInt(document.getElementById('filter-floor-max').value) : null,
        
        // Additional filters as JSON
        additional_filters: JSON.stringify({
            status: document.getElementById('filter-status').value || '',
            finishing: document.getElementById('filter-finishing').value || '',
            buildingClass: document.getElementById('filter-class') ? document.getElementById('filter-class').value : '',
            material: document.getElementById('filter-material') ? document.getElementById('filter-material').value : '',
            ceilingMin: document.getElementById('filter-ceiling-min') ? document.getElementById('filter-ceiling-min').value : '',
            ceilingMax: document.getElementById('filter-ceiling-max') ? document.getElementById('filter-ceiling-max').value : '',
            hasBalcony: document.getElementById('filter-balcony') ? document.getElementById('filter-balcony').checked : false,
            hasParking: document.getElementById('filter-parking') ? document.getElementById('filter-parking').checked : false,
            hasView: document.getElementById('filter-view') ? document.getElementById('filter-view').checked : false,
            isPenthouse: document.getElementById('filter-penthouse') ? document.getElementById('filter-penthouse').checked : false,
            familyMortgage: document.getElementById('filter-family-mortgage') ? document.getElementById('filter-family-mortgage').checked : false,
            itMortgage: document.getElementById('filter-it-mortgage') ? document.getElementById('filter-it-mortgage').checked : false,
            militaryMortgage: document.getElementById('filter-military-mortgage') ? document.getElementById('filter-military-mortgage').checked : false,
            ruralMortgage: document.getElementById('filter-rural-mortgage') ? document.getElementById('filter-rural-mortgage').checked : false
        })
    };
};

// Show saved searches from server
window.showSavedSearches = function() {
    loadSavedSearchesPage();
};

async function loadSavedSearchesPage() {
    try {
        const response = await fetch('/api/searches', {
            method: 'GET',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            displaySavedSearchesModal(result.searches);
        } else {
            alert('Ошибка загрузки сохранённых поисков');
        }
    } catch (error) {
        console.error('Error loading saved searches:', error);
        alert('Ошибка загрузки сохранённых поисков');
    }
}

function displaySavedSearchesModal(searches) {
    if (searches.length === 0) {
        alert('У вас нет сохранённых поисков');
        return;
    }
    
    const searchesHTML = searches.map(search => `
        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">${search.name}</h4>
                    <div class="text-sm text-gray-600 mt-1">
                        Создан: ${search.created_at}
                    </div>
                    ${getSearchSummary(search)}
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="loadSavedSearch(${search.id})" class="px-3 py-1 bg-[#0088cc] text-white text-sm rounded hover:bg-[#0077bb]">
                        Применить
                    </button>
                    <button onclick="deleteSavedSearch(${search.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                        Удалить
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    const modalHTML = `
        <div id="saved-searches-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Сохранённые поиски</h3>
                    <button onclick="closeSavedSearchesModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="searches-list">
                    ${searchesHTML}
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeSavedSearchesModal() {
    const modal = document.getElementById('saved-searches-modal');
    if (modal) modal.remove();
}

function getSearchSummary(search) {
    const parts = [];
    
    if (search.property_type) parts.push(search.property_type);
    if (search.location) parts.push('в ' + search.location);
    if (search.price_min || search.price_max) {
        let priceRange = '';
        if (search.price_min) priceRange += `от ${formatPrice(search.price_min)}`;
        if (search.price_max) priceRange += ` до ${formatPrice(search.price_max)}`;
        parts.push(priceRange);
    }
    if (search.developer) parts.push('от ' + search.developer);
    if (search.complex_name) parts.push('ЖК ' + search.complex_name);

    if (parts.length === 0) return '';
    return `<div class="mt-2 text-sm text-gray-600">${parts.join(', ')}</div>`;
}

function formatPrice(price) {
    if (price >= 1000000) {
        return (price / 1000000).toFixed(1) + 'млн';
    }
    return price.toLocaleString() + 'р';
}

async function loadSavedSearch(searchId) {
    try {
        const response = await fetch(`/api/searches/${searchId}/apply`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            applySavedSearch(result.search);
            closeSavedSearchesModal();
            alert('Поиск применён');
        } else {
            alert('Ошибка при применении поиска');
        }
    } catch (error) {
        console.error('Error applying search:', error);
        alert('Ошибка при применении поиска');
    }
}

function applySavedSearch(search) {
    // Clear current filters
    document.getElementById('filter-district').value = '';
    document.getElementById('filter-developer').value = '';
    document.getElementById('filter-rooms').value = '';
    document.getElementById('filter-complex').value = '';
    document.getElementById('filter-price-min').value = '';
    document.getElementById('filter-price-max').value = '';
    document.getElementById('filter-area-min').value = '';
    document.getElementById('filter-area-max').value = '';
    
    // Apply basic filters
    if (search.location) document.getElementById('filter-district').value = search.location;
    if (search.developer) document.getElementById('filter-developer').value = search.developer;
    if (search.property_type) document.getElementById('filter-rooms').value = search.property_type;
    if (search.complex_name) document.getElementById('filter-complex').value = search.complex_name;
    
    // Apply price filters (convert from rubles to millions)
    if (search.price_min) document.getElementById('filter-price-min').value = (search.price_min / 1000000).toString();
    if (search.price_max) document.getElementById('filter-price-max').value = (search.price_max / 1000000).toString();
    
    // Apply size filters
    if (search.size_min) document.getElementById('filter-area-min').value = search.size_min.toString();
    if (search.size_max) document.getElementById('filter-area-max').value = search.size_max.toString();
    
    // Apply additional filters if available
    if (search.additional_filters) {
        try {
            const additionalFilters = JSON.parse(search.additional_filters);
            
            if (additionalFilters.status && document.getElementById('filter-status')) {
                document.getElementById('filter-status').value = additionalFilters.status;
            }
            if (additionalFilters.finishing && document.getElementById('filter-finishing')) {
                document.getElementById('filter-finishing').value = additionalFilters.finishing;
            }
            
            // Apply advanced filters
            if (document.getElementById('filter-class') && additionalFilters.buildingClass) {
                document.getElementById('filter-class').value = additionalFilters.buildingClass;
            }
            if (document.getElementById('filter-material') && additionalFilters.material) {
                document.getElementById('filter-material').value = additionalFilters.material;
            }
            
            // Apply checkboxes
            if (document.getElementById('filter-balcony')) document.getElementById('filter-balcony').checked = additionalFilters.hasBalcony || false;
            if (document.getElementById('filter-parking')) document.getElementById('filter-parking').checked = additionalFilters.hasParking || false;
            if (document.getElementById('filter-view')) document.getElementById('filter-view').checked = additionalFilters.hasView || false;
            if (document.getElementById('filter-penthouse')) document.getElementById('filter-penthouse').checked = additionalFilters.isPenthouse || false;
            
        } catch (e) {
            console.log('Could not parse additional filters:', e);
        }
    }
    
    // Execute search
    searchApartments();
}

async function deleteSavedSearch(searchId) {
    if (!confirm('Удалить сохранённый поиск?')) return;
    
    try {
        const response = await fetch(`/api/searches/${searchId}`, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the searches modal
            closeSavedSearchesModal();
            loadSavedSearchesPage();
        } else {
            alert('Ошибка при удалении поиска');
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('Ошибка при удалении поиска');
    }
};

// View property details
window.viewProperty = function(propertyId) {
    // Open property in new tab or modal
    window.open(`/property/${propertyId}`, '_blank');
};

// Load clients - Global scope - MAIN FUNCTION
window.loadClients = function() {
    console.log('🔄 Loading clients...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('❌ clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка клиентов...</td></tr>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('📡 Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Clients data received:', data);
            if (data.success) {
                console.log('✅ Success! Displaying', data.clients.length, 'clients');
                displayClients(data.clients);
                updateClientSelect(data.clients);
                // Update count in tab
                const countElement = document.getElementById('clients-count');
                if (countElement) {
                    countElement.textContent = data.clients.length;
                }
            } else {
                console.error('❌ API returned error:', data.error);
                tableBody.innerHTML = 
                    `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('💥 Network error loading clients:', error);
            tableBody.innerHTML = 
                '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Ошибка загрузки клиентов</td></tr>';
        });
}

// Ensure displayClients is available
window.displayClients = function(clients) {
    console.log('📝 Displaying clients:', clients);
    const tbody = document.getElementById('clients-table-body');
    if (!tbody) {
        console.error('❌ Table body not found');
        return;
    }
    
    if (!clients || clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Клиенты не найдены</td></tr>';
        return;
    }
    
    tbody.innerHTML = clients.map(client => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${client.full_name || 'Не указано'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || 'Не указано'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    Активен
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">Редактировать</button>
                <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">Удалить</button>
            </td>
        </tr>
    `).join('');
}

// Removed duplicate - using window.displayClients above

function updateClientSelect(clients) {
    const select = document.getElementById('collection-client');
    select.innerHTML = '<option value="">Выберите клиента</option>' + 
        clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
}

// Load recommendations - Global scope
window.loadRecommendations = function() {
    console.log('Loading recommendations...');
    fetch('/api/manager/recommendations')
        .then(response => response.json())
        .then(data => {
            console.log('Recommendations data received:', data);
            if (data.success) {
                displayRecommendations(data.recommendations);
                updateRecommendationsStats(data.stats || {});
            } else {
                console.error('Failed to load recommendations:', data.error);
                document.getElementById('recommendations-container').innerHTML = 
                    '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-center py-8 text-red-500">Ошибка загрузки рекомендаций</div>';
        });
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Рекомендации не найдены</div>';
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-medium text-gray-900">${rec.property_title || 'Объект недвижимости'}</h4>
                    <p class="text-sm text-gray-600">Клиент: ${rec.client_name}</p>
                </div>
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(rec.status)}">
                    ${getStatusText(rec.status)}
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-2">${rec.message || 'Рекомендация отправлена'}</p>
            <div class="text-xs text-gray-500">
                Отправлено: ${new Date(rec.created_at).toLocaleDateString('ru-RU')}
            </div>
        </div>
    `).join('');
}

function updateRecommendationsStats(stats) {
    document.getElementById('recommendations-sent').textContent = stats.sent || 0;
    document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
    document.getElementById('recommendations-interested').textContent = stats.interested || 0;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-blue-100 text-blue-800',
        'viewed': 'bg-green-100 text-green-800',
        'interested': 'bg-purple-100 text-purple-800',
        'not_interested': 'bg-gray-100 text-gray-800',
        'scheduled_viewing': 'bg-orange-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': 'Отправлено',
        'viewed': 'Просмотрено',
        'interested': 'Заинтересованы',
        'not_interested': 'Не заинтересованы',
        'scheduled_viewing': 'Просмотр назначен'
    };
    return texts[status] || 'Неизвестно';
}

// Load complexes for filter
function loadComplexes() {
    fetch('/api/complexes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('filter-complex');
                select.innerHTML = '<option value="">Все ЖК</option>' + 
                    data.complexes.map(complex => `<option value="${complex.id}">${complex.name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading complexes:', error));
}

// Edit client function
window.editClient = function(clientId) {
    // Find client data using correct endpoint
    fetch(`/manager/get-client/${clientId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            console.log('Client data received:', data);
            if (data.success) {
                const client = data;
                
                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Редактировать клиента</h3>
                        <form id="edit-client-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя</label>
                                    <input type="text" id="edit-client-full-name" value="${client.full_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="edit-client-email" value="${client.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                                    <input type="tel" id="edit-client-phone" value="${client.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                                    <select id="edit-client-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="1" ${client.is_active ? 'selected' : ''}>Активен</option>
                                        <option value="0" ${!client.is_active ? 'selected' : ''}>Неактивен</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">Отмена</button>
                                <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">Сохранить</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('edit-client-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveClientChanges(clientId);
                });
            } else {
                alert('Ошибка загрузки данных клиента');
            }
        })
        .catch(error => {
            console.error('Error loading client:', error);
            alert('Ошибка загрузки данных клиента');
        });
};

// Delete client function
window.deleteClient = function(clientId, clientName) {
    if (confirm(`Вы уверены, что хотите удалить клиента "${clientName}"?`)) {
        fetch(`/manager/delete-client`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `client_id=${clientId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Клиент успешно удален');
                loadClients(); // Reload the clients list
            } else {
                alert(data.message || 'Ошибка при удалении клиента');
            }
        })
        .catch(error => {
            console.error('Error deleting client:', error);
            alert('Ошибка при удалении клиента');
        });
    }
};

// Close edit modal
window.closeEditModal = function() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
};

// Save client changes
function saveClientChanges(clientId) {
    const formData = new FormData();
    formData.append('client_id', clientId);
    formData.append('full_name', document.getElementById('edit-client-full-name').value);
    formData.append('email', document.getElementById('edit-client-email').value);
    formData.append('phone', document.getElementById('edit-client-phone').value);
    if (document.getElementById('edit-client-status').value === '1') {
        formData.append('is_active', 'on');
    }
    
    fetch(`/manager/edit-client`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Данные клиента обновлены');
            closeEditModal();
            loadClients(); // Reload the clients list
        } else {
            alert(data.message || 'Ошибка при сохранении');
        }
    })
    .catch(error => {
        console.error('Error saving client:', error);
        alert('Ошибка при сохранении');
    });
}

// Show add client modal
function showAddClientModal() {
    console.log('showAddClientModal called');
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Добавить нового клиента</h3>
            <form id="add-client-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя *</label>
                        <input type="text" id="add-client-full-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required minlength="2" maxlength="100">
                        <div class="text-xs text-gray-500 mt-1">Введите имя и фамилию</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="add-client-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                        <div class="text-xs text-gray-500 mt-1">Формат: example@domain.com</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                        <input type="tel" id="add-client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="+7-918-123-45-67">
                        <div class="text-xs text-gray-500 mt-1">Формат: +7-918-123-45-67</div>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="add-client-active" checked class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Активный клиент</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddClientModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">Добавить</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add phone number formatting with better UX
    const phoneInput = document.getElementById('add-client-phone');
    phoneInput.addEventListener('input', function(e) {
        let cursorPosition = e.target.selectionStart;
        let value = e.target.value.replace(/\D/g, '');
        
        // Handle different input patterns
        if (value.startsWith('7')) {
            value = value.substring(1);
        } else if (value.startsWith('8')) {
            value = value.substring(1);
        }
        
        let formattedValue = '';
        if (value.length > 0) {
            formattedValue = '+7';
            if (value.length >= 1) {
                formattedValue += '-' + value.substring(0, Math.min(3, value.length));
            }
            if (value.length >= 4) {
                formattedValue += '-' + value.substring(3, Math.min(6, value.length));
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, Math.min(8, value.length));
            }
            if (value.length >= 9) {
                formattedValue += '-' + value.substring(8, Math.min(10, value.length));
            }
        }
        
        e.target.value = formattedValue;
        
        // Restore cursor position approximately
        if (cursorPosition <= formattedValue.length) {
            e.target.setSelectionRange(cursorPosition, cursorPosition);
        }
    });
    
    // Auto-start with +7- when user starts typing
    phoneInput.addEventListener('focus', function(e) {
        if (!e.target.value) {
            e.target.value = '+7-';
        }
    });
    
    // Clear placeholder text on empty
    phoneInput.addEventListener('blur', function(e) {
        if (e.target.value === '+7-' || e.target.value === '+7') {
            e.target.value = '';
        }
    });
    
    // Handle form submission
    document.getElementById('add-client-form').addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        e.preventDefault();
        console.log('Default prevented, calling validateAndSaveNewClient');
        validateAndSaveNewClient();
    });
}

// Close add client modal
function closeAddClientModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Validate and save new client
function validateAndSaveNewClient() {
    const fullName = document.getElementById('add-client-full-name').value.trim();
    const email = document.getElementById('add-client-email').value.trim();
    const phone = document.getElementById('add-client-phone').value.trim();
    
    console.log('Validating client data:', {fullName, email, phone});
    
    // Validation
    if (!fullName || fullName.length < 2) {
        alert('Пожалуйста, введите корректное полное имя (минимум 2 символа)');
        return;
    }
    
    // Email validation
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    if (!email || !emailRegex.test(email)) {
        alert('Пожалуйста, введите корректный email адрес');
        return;
    }
    
    // Phone validation (optional but must be correct format if provided)
    const phoneRegex = /^\+7-\d{3}-\d{3}-\d{2}-\d{2}$/;
    if (phone && !phoneRegex.test(phone)) {
        alert('Пожалуйста, введите телефон в формате +7-918-123-45-67 или оставьте поле пустым');
        return;
    }
    
    console.log('Validation passed, calling saveNewClient');
    saveNewClient(fullName, email, phone);
}

// Save new client
function saveNewClient(fullName, email, phone) {
    const requestData = {
        full_name: fullName,
        email: email,
        phone: phone || null,
        is_active: document.getElementById('add-client-active').checked
    };
    
    console.log('Sending client data:', requestData);
    
    fetch('/api/manager/add-client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            alert(`Клиент "${fullName}" успешно добавлен!`);
            closeAddClientModal();
            
            // Force reload clients with a small delay to ensure server processing
            setTimeout(() => {
                loadClients();
                // Also update the client select dropdown
                loadClientsForCollectionSelect();
            }, 500);
        } else {
            alert(data.error || 'Ошибка при добавлении клиента');
        }
    })
    .catch(error => {
        console.error('Error adding client:', error);
        alert('Ошибка при добавлении клиента. Проверьте подключение к интернету.');
    });
}

// Load clients for collection select dropdown
function loadClientsForCollectionSelect() {
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('collection-client');
                if (select) {
                    select.innerHTML = '<option value="">Выберите клиента</option>' + 
                        data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
                }
            }
        })
        .catch(error => console.error('Error loading clients for collection select:', error));
}

// Event listeners
// Remove application modal functionality - causes unwanted popups
function removeApplicationModals() {
    // Remove any existing application modals
    const modals = document.querySelectorAll('.modal, [id*="application"], [id*="Application"]');
    modals.forEach(modal => {
        if (modal.id !== 'user-menu' && !modal.closest('.content-section')) {
            modal.remove();
        }
    });
    
    // Disable any application form handlers
    const forms = document.querySelectorAll('form[action*="application"]');
    forms.forEach(form => form.style.display = 'none');
}

document.addEventListener('DOMContentLoaded', function() {
    // Remove unwanted application modals first
    removeApplicationModals();
    // No auto-activation - let other handler manage initial section
    
    // Toggle advanced filters (only if element exists)
    const toggleFiltersButton = document.getElementById('toggle-advanced-filters');
    if (toggleFiltersButton) {
        toggleFiltersButton.addEventListener('click', function() {
            const advancedFilters = document.getElementById('advanced-filters');
            const button = this;
            
            if (advancedFilters && advancedFilters.classList.contains('manager-favorites-hidden')) {
                advancedFilters.classList.remove('manager-favorites-hidden');
                button.textContent = '- Скрыть дополнительные фильтры';
            } else if (advancedFilters) {
                advancedFilters.classList.add('manager-favorites-hidden');
                button.textContent = '+ Дополнительные фильтры';
            }
        });
    }

    // View toggle buttons (only if elements exist)
    const viewGridBtn = document.getElementById('view-grid-btn');
    const viewListBtn = document.getElementById('view-list-btn');
    
    if (viewGridBtn) {
        viewGridBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'grid';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewListBtn) {
                viewListBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewListBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }

    if (viewListBtn) {
        viewListBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'list';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewGridBtn) {
                viewGridBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewGridBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }
    
    // Search apartments button
    document.getElementById('search-apartments-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        searchApartments();
    });
    
    // Add filter change listeners to trigger search
    ['filter-district', 'filter-developer', 'filter-rooms', 'filter-complex', 'filter-price-min', 'filter-price-max', 'filter-area-min', 'filter-area-max', 'filter-floor-min', 'filter-floor-max', 'filter-status', 'filter-finishing'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                // Only search if we already have results
                const container = document.getElementById('properties-results');
                if (container && !container.querySelector('p')) {
                    searchApartments();
                }
            });
        }
    });

    // Load complexes for filter
    loadComplexes();
    
    // Add client button
    document.getElementById('add-client-btn').addEventListener('click', function() {
        showAddClientModal();
    });
    
    // Clear selection button
    document.getElementById('clear-selection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectedProperties = [];
        updateSelectedProperties();
        updateButtons();
        
        // Refresh search results
        const searchContainer = document.getElementById('properties-results');
        if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>') {
            searchApartments();
        }
    });
    
    // Save collection button
    document.getElementById('save-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('Заполните все поля и выберите объекты');
            return;
        }
        
        fetch('/api/manager/collections', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                client_id: clientId,
                property_ids: selectedProperties
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Подборка успешно создана!');
                // Reset form
                document.getElementById('collection-name').value = '';
                document.getElementById('collection-client').value = '';
                selectedProperties = [];
                updateSelectedProperties();
                updateButtons();
                // Clear search results
                document.getElementById('properties-results').innerHTML = 
                    '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>';
            } else {
                alert('Ошибка создания подборки: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving collection:', error);
            alert('Ошибка сохранения подборки');
        });
    });
    
    // Send collection button
    document.getElementById('send-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('Заполните все поля и выберите объекты');
            return;
        }
        
        if (confirm('Отправить подборку клиенту по email?')) {
            fetch('/api/manager/send-collection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    client_id: clientId,
                    property_ids: selectedProperties
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Подборка отправлена клиенту!');
                    // Reset form
                    document.getElementById('collection-name').value = '';
                    document.getElementById('collection-client').value = '';
                    selectedProperties = [];
                    updateSelectedProperties();
                    updateButtons();
                    // Clear search results
                    document.getElementById('properties-results').innerHTML = 
                        '<p class="text-gray-500 col-span-full text-center py-8">Нажмите "Найти квартиры" для поиска</p>';
                } else {
                    alert('Ошибка отправки: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error sending collection:', error);
                alert('Ошибка отправки подборки');
            });
        }
    });
    
    // Load initial data based on active section
    loadClients();
    
    // Clean up any remaining unwanted modals periodically
    setInterval(removeApplicationModals, 5000);
});

// Manager Saved Searches functionality
window.loadManagerSavedSearches = async function() {
    try {
        const response = await fetch('/api/manager/saved-searches');
        const data = await response.json();
        
        const grid = document.getElementById('saved-searches-grid');
        if (!data.success || !data.searches.length) {
            grid.innerHTML = `
                <div class="text-center py-12 col-span-full">
                    <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                        <i class="fas fa-search text-4xl"></i>
                    </div>
                    <p class="text-gray-500 text-lg mb-4">У вас пока нет сохранённых поисков</p>
                    <button onclick="createNewSearch()" class="px-6 py-3 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition-colors">
                        <i class="fas fa-plus mr-2"></i>Создать первый поиск
                    </button>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = data.searches.map(search => `
            <div class="bg-gray-50 rounded-lg border p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg text-gray-800 mb-1">${search.name}</h3>
                        ${search.description ? `<p class="text-sm text-gray-600 mb-2">${search.description}</p>` : ''}
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${search.additional_filters ? formatSearchFilters(JSON.parse(search.additional_filters)) : ''}
                        </div>
                        <div class="flex items-center text-sm text-gray-500 space-x-4">
                            <span><i class="fas fa-calendar mr-1"></i>${formatDate(search.created_at)}</span>
                            <span><i class="fas fa-paper-plane mr-1"></i>Отправлен ${search.usage_count || 0} раз</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white text-sm rounded-md hover:bg-[#0077bb] transition-colors">
                        <i class="fas fa-share mr-1"></i>Отправить клиенту
                    </button>
                    <button onclick="editManagerSearch(${search.id})" class="px-3 py-2 text-gray-600 border border-gray-300 text-sm rounded-md hover:bg-gray-50 transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteManagerSearch(${search.id})" class="px-3 py-2 text-[#0088CC] border border-gray-300 text-sm rounded-md hover:bg-red-50 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        // Update saved searches count in menu
        const savedSearchesCount = document.getElementById('saved-searches-count');
        if (savedSearchesCount) {
            savedSearchesCount.textContent = data.searches.length;
            savedSearchesCount.style.display = data.searches.length > 0 ? 'inline' : 'none';
            console.log('🔄 Updated saved searches count to:', data.searches.length);
        }
        
    } catch (error) {
        console.error('Error loading saved searches:', error);
        document.getElementById('saved-searches-grid').innerHTML = `
            <div class="text-center py-8 col-span-full">
                <p class="text-red-500">Ошибка загрузки сохранённых поисков</p>
            </div>
        `;
    }
};

window.createNewSearch = function() {
    window.open('/properties', '_blank');
};

window.sendSearchToClient = async function(searchId) {
    // Open modal to select client
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">Отправить поиск клиенту</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                    <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]">
                        <option value="">Выберите клиента...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Сообщение (необязательно)</label>
                    <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]" placeholder="Дополнительное сообщение для клиента..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeSendSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients into select
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('client-select');
        if (data.success && data.clients.length > 0) {
            select.innerHTML = '<option value="">Выберите клиента...</option>' + 
                data.clients.map(client => `<option value="${client.id}">${client.full_name} (${client.email})</option>`).join('');
        } else {
            select.innerHTML = '<option value="">Клиенты не найдены</option>';
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = async function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value.trim();
    
    if (!clientId) {
        alert('Выберите клиента');
        return;
    }
    
    try {
        const response = await fetch('/api/manager/send-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                search_id: searchId,
                client_id: clientId,
                message: message
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Поиск успешно отправлен клиенту!');
            closeSendSearchModal();
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('Ошибка отправки: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending search:', error);
        alert('Ошибка отправки поиска');
    }
};

window.deleteManagerSearch = async function(searchId) {
    if (!confirm('Удалить сохранённый поиск?')) return;
    
    try {
        const response = await fetch(`/api/manager/saved-search/${searchId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('Ошибка удаления: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('Ошибка удаления поиска');
    }
};

function formatSearchFilters(filters) {
    const tags = [];
    if (filters.rooms && filters.rooms.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${filters.rooms.join(', ')}</span>`);
    }
    if (filters.districts && filters.districts.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-green-800 text-xs rounded-full">${filters.districts.join(', ')}</span>`);
    }
    if (filters.priceTo || filters.priceFrom) {
        const priceText = `${filters.priceFrom || '0'}-${filters.priceTo || '∞'} млн`;
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-yellow-800 text-xs rounded-full">${priceText}</span>`);
    }
    if (filters.developers && filters.developers.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-purple-800 text-xs rounded-full">${filters.developers[0]}${filters.developers.length > 1 ? '...' : ''}</span>`);
    }
    return tags.join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('ru-RU');
}

// Recommendations functionality - using global window.loadRecommendations

function updateRecommendationStats(recommendations) {
    const stats = {
        sent: recommendations.length,
        viewed: recommendations.filter(r => r.viewed_at).length,
        interested: recommendations.filter(r => r.client_response === 'interested').length,
        scheduled: recommendations.filter(r => r.viewing_scheduled_at).length
    };
    
    document.getElementById('recommendations-sent').textContent = stats.sent;
    document.getElementById('recommendations-viewed').textContent = stats.viewed;
    document.getElementById('recommendations-interested').textContent = stats.interested;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled;
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-paper-plane text-4xl mb-4"></i>
                <p>Рекомендации не найдены</p>
                <p class="text-sm">Перейдите на страницу недвижимости, чтобы отправить первую рекомендацию</p>
            </div>
        `;
        return;
    }
    
    const html = recommendations.map(rec => {
        const statusClass = getStatusClass(rec.status);
        const priorityClass = getPriorityClass(rec.priority_level);
        const createdAt = new Date(rec.created_at).toLocaleDateString('ru-RU');
        const viewedAt = rec.viewed_at ? new Date(rec.viewed_at).toLocaleDateString('ru-RU') : null;
        
        return `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">${rec.title}</h4>
                        <p class="text-gray-600 text-sm mb-2">
                            <i class="fas ${rec.recommendation_type === 'property' ? 'fa-home' : 'fa-building'} mr-1"></i>
                            ${rec.recommendation_type === 'property' ? 'Квартира' : 'ЖК'}: ${rec.item_name}
                        </p>
                        <p class="text-gray-700 text-sm">
                            <i class="fas fa-user mr-1"></i>
                            Клиент: ${rec.client_name} (${rec.client_email})
                        </p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                            ${getStatusText(rec.status)}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full ${priorityClass}">
                            ${getPriorityText(rec.priority_level)}
                        </span>
                    </div>
                </div>
                
                ${rec.description ? `<p class="text-gray-600 mb-3">${rec.description}</p>` : ''}
                ${rec.manager_notes ? `<p class="text-sm text-gray-500 bg-gray-50 p-2 rounded mb-3"><strong>Ваши заметки:</strong> ${rec.manager_notes}</p>` : ''}
                
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <div>
                        <span>Отправлено: ${createdAt}</span>
                        ${viewedAt ? ` • <span class="text-green-600">Просмотрено: ${viewedAt}</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${rec.recommendation_type === 'property' ? 
                            `<a href="/object/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">Посмотреть объект</a>` :
                            `<a href="/complex/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">Посмотреть ЖК</a>`
                        }
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-gray-100 text-gray-700',
        'viewed': 'bg-gray-100 text-green-800', 
        'interested': 'bg-gray-100 text-purple-800',
        'not_interested': 'bg-gray-100 text-red-800',
        'scheduled_viewing': 'bg-gray-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getPriorityClass(priority) {
    const classes = {
        'urgent': 'bg-gray-100 text-red-800',
        'high': 'bg-gray-100 text-orange-800',
        'normal': 'bg-gray-100 text-gray-800',
        'low': 'bg-gray-100 text-green-800'
    };
    return classes[priority] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': 'Отправлено',
        'viewed': 'Просмотрено',
        'interested': 'Заинтересованы',
        'not_interested': 'Не заинтересованы',
        'scheduled_viewing': 'Просмотр назначен'
    };
    return texts[status] || 'Неизвестно';
}

function getPriorityText(priority) {
    const texts = {
        'urgent': 'Срочно',
        'high': 'Высокий',
        'normal': 'Обычный',
        'low': 'Низкий'
    };
    return texts[priority] || 'Обычный';
}

// Adaptive welcome message function
window.loadWelcomeMessage = function() {
    console.log('🌟 Loading adaptive welcome message...');
    fetch('/api/manager/welcome-message')
        .then(response => {
            console.log('📡 Welcome message response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Welcome message data received:', data);
            if (data.success) {
                const container = document.getElementById('welcome-messages');
                const iconContainer = document.getElementById('welcome-icon');
                
                if (!container) {
                    console.error('❌ welcome-messages container not found');
                    return;
                }
                
                // Create messages HTML
                const messagesHtml = data.messages.map((message, index) => {
                    if (index === 0) {
                        // First message is the title
                        document.getElementById('welcome-title').textContent = message;
                        return '';
                    } else {
                        // Subsequent messages
                        const className = index === 1 ? 'text-lg text-gray-600' : 'text-base text-gray-500';
                        return `<p class="${className}">${message}</p>`;
                    }
                }).filter(html => html).join('');
                
                container.innerHTML = messagesHtml;
                
                // Update icon based on activity context
                if (data.context && iconContainer) {
                    const icon = iconContainer.querySelector('svg');
                    if (data.context.high_activity) {
                        // High activity - star icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-green-500 to-green-600');
                    } else if (data.context.needs_attention) {
                        // Needs attention - notification icon
                        icon.innerHTML = '<path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-orange-500 to-orange-600');
                    } else if (data.context.new_day) {
                        // New day - sun icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-yellow-500 to-yellow-600');
                    }
                }
                
                console.log('✅ Welcome message loaded successfully');
            } else {
                console.error('❌ API returned error:', data.error);
            }
        })
        .catch(error => {
            console.error('💥 Error loading welcome message:', error);
        });
};

window.loadRecentRecommendations = function() {
    console.log('🔄 Loading manager activity feed...');
    fetch('/api/manager/activity-feed')
        .then(response => {
            console.log('📡 Activity feed response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Activity feed data received:', data);
            if (data.success) {
                const recentActivities = data.activities.slice(0, 5);
                const container = document.getElementById('recent-recommendations');
                
                if (!container) {
                    console.error('❌ recent-recommendations container not found');
                    return;
                }
                
                if (recentActivities.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">Активности пока нет</div>';
                    return;
                }
                
                const html = recentActivities.map(activity => {
                    let iconClass = 'fas fa-info-circle text-blue-600';
                    let bgColor = 'bg-blue-50';
                    
                    if (activity.type === 'presentation_view') {
                        iconClass = 'fas fa-eye text-purple-600';
                        bgColor = 'bg-purple-50';
                    } else if (activity.type === 'recommendation') {
                        iconClass = 'fas fa-paper-plane text-blue-600';
                        bgColor = 'bg-blue-50';
                    }
                    
                    return `
                        <div class="flex items-start space-x-3 p-3 ${bgColor} rounded-lg">
                            <div class="flex-shrink-0 mt-0.5">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm text-gray-900">${activity.title}</p>
                                <p class="text-xs text-gray-600 mt-1">${activity.description}</p>
                                <span class="text-xs text-gray-500">${activity.time_ago}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                console.log('✅ Manager activity feed loaded successfully');
            } else {
                console.error('❌ API returned error:', data.error);
                const container = document.getElementById('recent-recommendations');
                if (container) {
                    container.innerHTML = '<div class="text-red-500 text-sm">Ошибка загрузки активности</div>';
                }
            }
        })
        .catch(error => {
            console.error('💥 Error loading activity feed:', error);
            const container = document.getElementById('recent-recommendations');
            if (container) {
                container.innerHTML = '<div class="text-red-500 text-sm">Ошибка загрузки активности</div>';
            }
        });
};

// Load recommendations function
function loadRecommendations() {
    // Get filter values
    const clientFilter = document.getElementById('rec-filter-client').value;
    const statusFilter = document.getElementById('rec-filter-status').value;
    const typeFilter = document.getElementById('rec-filter-type').value;
    const priorityFilter = document.getElementById('rec-filter-priority').value;
    
    // Build query params
    const params = new URLSearchParams();
    if (clientFilter) params.append('client_id', clientFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);
    if (priorityFilter) params.append('priority', priorityFilter);
    
    const url = '/api/manager/recommendations' + (params.toString() ? '?' + params.toString() : '');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const recommendations = data.recommendations;
                const stats = data.stats;
                
                // Update stats
                document.getElementById('recommendations-sent').textContent = stats.sent || 0;
                document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
                document.getElementById('recommendations-interested').textContent = stats.interested || 0;
                document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
                document.getElementById('sidebar-recommendations-count').textContent = stats.sent || 0;
                
                // Update recommendations list
                const container = document.getElementById('recommendations-container');
                if (recommendations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>Рекомендации не найдены</p>
                            <p class="text-sm mt-2">Отправьте первые рекомендации клиентам через страницу "Недвижимость"</p>
                        </div>
                    `;
                    return;
                }
                
                const html = recommendations.map(rec => {
                    const statusClass = {
                        'sent': 'bg-gray-100 text-gray-700',
                        'viewed': 'bg-gray-100 text-green-800',
                        'interested': 'bg-gray-100 text-purple-800',
                        'not_interested': 'bg-gray-100 text-gray-800',
                        'scheduled_viewing': 'bg-gray-100 text-orange-800'
                    }[rec.status] || 'bg-gray-100 text-gray-800';
                    
                    const statusText = {
                        'sent': 'Отправлено',
                        'viewed': 'Просмотрено',
                        'interested': 'Заинтересованы',
                        'not_interested': 'Не заинтересованы',
                        'scheduled_viewing': 'Просмотр назначен'
                    }[rec.status] || rec.status;
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 mb-1">${rec.title}</h3>
                                    <p class="text-sm text-gray-600">для ${rec.client_name} (${rec.client_email})</p>
                                    <p class="text-xs text-gray-500 mt-1">${rec.item_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            
                            ${rec.description ? `<p class="text-sm text-gray-700 mb-3">${rec.description}</p>` : ''}
                            
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Отправлено: ${new Date(rec.sent_at).toLocaleDateString('ru-RU')}</span>
                                <div class="flex items-center gap-2">
                                    ${rec.viewed_at ? `<span>Просмотрено: ${new Date(rec.viewed_at).toLocaleDateString('ru-RU')}</span>` : ''}
                                    <button onclick="deleteRecommendation(${rec.id}, '${rec.title}')" 
                                            class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" 
                                            title="Удалить рекомендацию">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-red-500 text-center py-8">Ошибка загрузки рекомендаций</div>';
        });
}

// Delete recommendation function
function deleteRecommendation(recommendationId, title) {
    if (!confirm(`Вы уверены, что хотите удалить рекомендацию "${title}"?`)) {
        return;
    }
    
    fetch(`/api/manager/recommendations/${recommendationId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Рекомендация успешно удалена');
            loadRecommendations(); // Reload the list
        } else {
            alert(data.error || 'Ошибка при удалении рекомендации');
        }
    })
    .catch(error => {
        console.error('Error deleting recommendation:', error);
        alert('Ошибка при удалении рекомендации');
    });
}

// Load clients for filter
function loadClientsForFilter() {
    fetch('/api/manager/clients-list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('rec-filter-client');
                select.innerHTML = '<option value="">Все клиенты</option>' + 
                    data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading clients for filter:', error));
}

// Load collections function
function loadCollections() {
    console.log('Loading collections...');
    const container = document.getElementById('collections-grid');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Загрузка подборок...</p></div>';
    
    fetch('/api/manager/collections')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const collections = data.collections || [];
                
                if (collections.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 mb-2">У вас пока нет подборок</p>
                            <button onclick="showSection('create-collection')" class="text-[#0088cc] hover:text-[#006699] font-medium">
                                Создать первую подборку
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const html = collections.map(collection => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-gray-800">${collection.name}</h3>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(collection.status)}">
                                ${collection.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Клиент: ${collection.client_name || 'Не указан'}</p>
                        <p class="text-sm text-gray-500 mb-3">Объектов: ${collection.properties_count || 0}</p>
                        <p class="text-xs text-gray-500">Создано: ${new Date(collection.created_at).toLocaleDateString('ru-RU')}</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="viewCollection(${collection.id})" class="text-[#0088cc] hover:text-[#006699] text-sm">
                                Просмотр
                            </button>
                            <button onclick="editCollection(${collection.id})" class="text-gray-600 hover:text-gray-800 text-sm">
                                Редактировать
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Ошибка загрузки подборок</div>';
            }
        })
        .catch(error => {
            console.error('Error loading collections:', error);
            container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Ошибка загрузки подборок</div>';
        });
}

// Load applications function
function loadApplications() {
    console.log('Loading applications...');
    // For now, show a message that this section is under development
    const container = document.querySelector('#applications .overflow-x-auto table tbody');
    if (!container) {
        // If table body doesn't exist, find the applications section
        const appsSection = document.getElementById('applications');
        if (appsSection) {
            const tableContainer = appsSection.querySelector('.overflow-x-auto');
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 mb-2">Заявки на кешбек</p>
                        <p class="text-sm text-gray-400">Эта функция находится в разработке</p>
                    </div>
                `;
            }
        }
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
                Загрузка заявок...
            </td>
        </tr>
    `;
    
    // For demo, show empty state after a delay
    setTimeout(() => {
        container.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <i class="fas fa-file-alt text-2xl mb-2"></i>
                    <p>Заявки на кешбек пока отсутствуют</p>
                    <p class="text-sm mt-1">Клиенты смогут подавать заявки после покупки недвижимости</p>
                </td>
            </tr>
        `;
    }, 1000);
}

// Helper function for status classes
function getStatusClass(status) {
    const statusClasses = {
        'Черновик': 'bg-gray-100 text-gray-800',
        'Отправлена': 'bg-blue-100 text-blue-800',
        'Просмотрена': 'bg-green-100 text-green-800',
        'Архив': 'bg-red-100 text-red-800'
    };
    return statusClasses[status] || 'bg-gray-100 text-gray-800';
}

// Collection management functions
function viewCollection(collectionId) {
    // Redirect to collection view page
    window.location.href = `/manager/collection/${collectionId}`;
}

function editCollection(collectionId) {
    // For now, redirect to collection view
    viewCollection(collectionId);
}

// Ensure functions are available globally before initialization
window.showAddClientModal = function() {
    console.log('showAddClientModal called');
    const modal = document.getElementById('client-modal');
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error('Client modal not found');
    }
};

// Removed fallback functions - using main functions above

// Initialize on page load  
document.addEventListener('DOMContentLoaded', function() {
    console.log('Manager dashboard DOMContentLoaded - initializing...');
    
    // Setup initial view - only if no hash is present
    const hash = window.location.hash.replace('#', '');
    const initialSection = hash || 'dashboard';
    showSection(initialSection);
    
    // Load data with delay to ensure DOM is ready
    setTimeout(() => {
        console.log('Starting data load...');
        if (typeof window.loadClients === 'function') {
            window.loadClients();
        } else {
            console.error('loadClients function not available');
        }
        
        if (typeof window.loadRecommendations === 'function') {
            window.loadRecommendations();
        } else {
            console.error('loadRecommendations function not available');
        }
        
        // Load recent recommendations for main dashboard
        if (typeof window.loadRecentRecommendations === 'function') {
            window.loadRecentRecommendations();
        } else {
            console.error('loadRecentRecommendations function not available');
        }
        
        // Load adaptive welcome message
        if (typeof window.loadWelcomeMessage === 'function') {
            window.loadWelcomeMessage();
        } else {
            console.error('loadWelcomeMessage function not available');
        }
        
        if (typeof loadClientsForFilter === 'function') {
            loadClientsForFilter();
        }
    }, 500);
});

// Removed duplicate - now defined at top

// Presentation functions
function createPresentation() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Создать презентацию</h3>
            <form id="presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название презентации</label>
                    <input type="text" id="presentation-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Например: Подборка для семьи Ивановых" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Имя клиента</label>
                    <input type="text" id="client-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Иван Петров">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Телефон клиента</label>
                    <input type="tel" id="client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="+7 900 123 45 67">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                    <textarea id="presentation-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" rows="3" placeholder="Краткое описание презентации"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all">Создать</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value;
        const clientName = document.getElementById('client-name').value;
        const clientPhone = document.getElementById('client-phone').value;
        const description = document.getElementById('presentation-description').value;
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    client_name: clientName,
                    client_phone: clientPhone,
                    description: description
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadPresentations();
                showNotification('Презентация создана успешно!', 'success');
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('Ошибка при создании презентации', 'error');
        }
    });
}

function closeModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Show create presentation modal
function showCreatePresentationModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Создать презентацию</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="create-presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название презентации</label>
                    <input type="text" id="presentation-title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="Например: Лучшие предложения для Иванова">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Для клиента (необязательно)</label>
                    <input type="text" id="presentation-client" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="Имя клиента">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание (необязательно)</label>
                    <textarea id="presentation-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Краткое описание презентации"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg transition-colors">
                        Создать
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Handle form submission
    document.getElementById('create-presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value.trim();
        const client = document.getElementById('presentation-client').value.trim();
        const description = document.getElementById('presentation-description').value.trim();
        
        if (!title) {
            alert('Введите название презентации');
            return;
        }
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    title: title,
                    client_name: client || null,
                    description: description || null
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                showNotification('Презентация создана успешно!', 'success');
                loadPresentations(); // Refresh the list
            } else {
                showNotification(`Ошибка: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error creating presentation:', error);
            showNotification('Ошибка при создании презентации', 'error');
        }
    });
}

function closeCreatePresentationModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

function loadPresentations() {
    fetch('/api/manager/presentations', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Response status:', response.status);
            return response.text();
        })
        .then(text => {
            console.log('Raw response:', text);
            // Извлекаем JSON из ответа, игнорируя HTML редирект
            const jsonStart = text.indexOf('{');
            if (jsonStart !== -1) {
                const jsonText = text.substring(jsonStart);
                const data = JSON.parse(jsonText);
                if (data.success) {
                    displayPresentations(data.presentations);
                } else {
                    console.error('Error loading presentations:', data.error);
                }
            } else {
                console.error('No JSON found in response:', text);
            }
        })
        .catch(error => {
            console.error('Error loading presentations:', error);
        });
}

function displayPresentations(presentations) {
    const container = document.getElementById('presentations-container');
    
    if (!container) return;
    
    if (presentations.length === 0) {
        // Clear container safely
        container.textContent = '';
        
        // Create empty state safely using DOM methods
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-center py-12 col-span-full';
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'mx-auto h-12 w-12 text-gray-400');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('stroke', 'currentColor');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z');
        svg.appendChild(path);
        
        const title = document.createElement('h3');
        title.className = 'mt-2 text-sm font-medium text-gray-900';
        title.textContent = 'Нет презентаций';
        
        const subtitle = document.createElement('p');
        subtitle.className = 'mt-1 text-sm text-gray-500';
        subtitle.textContent = 'Создайте первую презентацию для клиентов';
        
        emptyDiv.appendChild(svg);
        emptyDiv.appendChild(title);
        emptyDiv.appendChild(subtitle);
        
        container.appendChild(emptyDiv);
        return;
    }
    
    // Clear container safely
    container.textContent = '';
    
    // Create presentations safely using DOM methods
    presentations.forEach(presentation => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
        
        // Header section
        const header = document.createElement('div');
        header.className = 'flex justify-between items-start mb-4';
        
        const headerLeft = document.createElement('div');
        
        const title = document.createElement('h4');
        title.className = 'text-lg font-semibold text-gray-900';
        title.textContent = presentation.title || 'Без названия';
        headerLeft.appendChild(title);
        
        if (presentation.client_name) {
            const clientInfo = document.createElement('p');
            clientInfo.className = 'text-sm text-gray-600';
            clientInfo.textContent = `Для: ${presentation.client_name}`;
            headerLeft.appendChild(clientInfo);
        }
        
        if (presentation.description) {
            const desc = document.createElement('p');
            desc.className = 'text-sm text-gray-500 mt-1';
            desc.textContent = presentation.description;
            headerLeft.appendChild(desc);
        }
        
        const headerRight = document.createElement('div');
        headerRight.className = 'flex items-center space-x-2';
        
        const propertyBadge = document.createElement('span');
        propertyBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800';
        propertyBadge.textContent = `${presentation.property_count || 0} объектов`;
        
        const viewBadge = document.createElement('span');
        viewBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
        viewBadge.textContent = `${presentation.view_count || 0} просмотров`;
        
        headerRight.appendChild(propertyBadge);
        headerRight.appendChild(viewBadge);
        
        header.appendChild(headerLeft);
        header.appendChild(headerRight);
        
        // Date section
        const dateSection = document.createElement('div');
        dateSection.className = 'flex justify-between items-center text-sm text-gray-500 mb-4';
        
        const createdDate = document.createElement('span');
        createdDate.textContent = `Создано: ${new Date(presentation.created_at).toLocaleDateString('ru-RU')}`;
        dateSection.appendChild(createdDate);
        
        if (presentation.last_viewed_at) {
            const viewedDate = document.createElement('span');
            viewedDate.textContent = `Последний просмотр: ${new Date(presentation.last_viewed_at).toLocaleDateString('ru-RU')}`;
            dateSection.appendChild(viewedDate);
        }
        
        // Actions section
        const actions = document.createElement('div');
        actions.className = 'flex justify-end space-x-2';
        
        const shareBtn = document.createElement('button');
        shareBtn.className = 'flex items-center text-gray-600 hover:text-gray-700 text-xs font-medium bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors';
        shareBtn.innerHTML = '<i class="fas fa-share mr-2"></i>Отправить';
        shareBtn.onclick = () => sharePresentation(presentation.id);
        
        const viewBtn = document.createElement('button');
        viewBtn.className = 'flex items-center text-gray-600 hover:text-gray-700 text-xs font-medium bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors';
        viewBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>Подробнее';
        viewBtn.onclick = (event) => {
            event.stopPropagation(); // Prevent bubbling to parent elements
            showPresentationInDashboard(presentation.id);
        };
        
        actions.appendChild(shareBtn);
        actions.appendChild(viewBtn);
        
        card.appendChild(header);
        card.appendChild(dateSection);
        card.appendChild(actions);
        
        container.appendChild(card);
    });
}

function sharePresentation(presentationId) {
    console.log(`🚀 Starting sharePresentation for ID: ${presentationId}`);
    
    fetch(`/api/manager/presentation/${presentationId}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({})
    })
    .then(response => {
        console.log(`📡 Response received:`, response);
        console.log(`📊 Response status: ${response.status}`);
        console.log(`📝 Response statusText: ${response.statusText}`);
        console.log(`📋 Response ok: ${response.ok}`);
        console.log(`📄 Response type: ${response.type}`);
        console.log(`🔗 Response url: ${response.url}`);
        
        if (!response.ok) {
            console.error(`❌ Response not ok: ${response.status} ${response.statusText}`);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log(`✅ Response ok, parsing JSON...`);
        return response.json();
    })
    .then(data => {
        console.log(`📦 JSON data received:`, data);
        
        if (data.success) {
            console.log(`✅ Success! Share data:`, data.share_data);
            const shareData = data.share_data;
            
            // Create share modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Отправить презентацию</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ссылка на презентацию</label>
                        <div class="flex">
                            <input type="text" id="presentation-url" value="${shareData.presentation_url}" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50" readonly>
                            <button onclick="copyToClipboard('presentation-url')" class="px-3 py-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Готовое сообщение</label>
                        <textarea id="message-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" rows="6" readonly>${shareData.message_text}</textarea>
                    </div>
                    
                    <div class="flex flex-col space-y-3">
                        <a href="${shareData.whatsapp_url}" target="_blank" class="flex items-center justify-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fab fa-whatsapp mr-2"></i>Отправить в WhatsApp
                        </a>
                        <a href="${shareData.telegram_url}" target="_blank" class="flex items-center justify-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fab fa-telegram mr-2"></i>Отправить в Telegram
                        </a>
                        <button onclick="copyToClipboard('message-text')" class="flex items-center justify-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-copy mr-2"></i>Копировать сообщение
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="closeModal()" class="w-full px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Закрыть</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(`🎉 Modal added to DOM successfully!`);
        } else {
            console.error(`❌ API returned error:`, data.error);
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Error in sharePresentation:', error);
        console.error('📍 Error name:', error.name);
        console.error('📝 Error message:', error.message);
        console.error('📚 Error stack:', error.stack);
        
        if (error.message.includes('Authentication required') || error.message.includes('401')) {
            showNotification('Ошибка: Необходимо войти в систему заново', 'error');
            setTimeout(() => window.location.href = '/manager/login', 2000);
        } else {
            showNotification(`Ошибка при получении ссылки: ${error.message}`, 'error');
        }
    });
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    showNotification('Скопировано в буфер обмена', 'success');
}

function viewPresentation(uniqueUrl) {
    window.open(`/presentation/modern/${uniqueUrl}`, '_blank');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Presentation viewer functions
function showPresentationInDashboard(presentationId) {
    console.log('🎯 NEW DEBUG v2.0 - Showing presentation in dashboard:', presentationId);
    
    // Hide list view
    const listView = document.getElementById('presentations-list-view');
    const viewerView = document.getElementById('presentation-viewer');
    
    console.log('🔍 DOM elements check:', {
        listView: listView ? 'found' : 'NOT FOUND',
        viewerView: viewerView ? 'found' : 'NOT FOUND'
    });
    
    if (listView && viewerView) {
        console.log('✅ Both elements found, hiding list and showing viewer');
        listView.style.display = 'none';
        viewerView.classList.remove('hidden');
        
        console.log('📞 About to call loadPresentationContent with ID:', presentationId);
        
        // Check if function exists
        if (typeof loadPresentationContent !== 'function') {
            console.error('❌ loadPresentationContent is not a function!');
            return;
        }
        
        console.log('✅ loadPresentationContent function exists, calling it...');
        
        // Load presentation content
        try {
            loadPresentationContent(presentationId);
            console.log('📞 loadPresentationContent call completed successfully');
        } catch (error) {
            console.error('❌ Error calling loadPresentationContent:', error);
        }
    } else {
        console.error('❌ Required DOM elements not found!');
    }
}

function showPresentationsList() {
    console.log('🔙 Returning to presentations list');
    
    // Show list view, hide viewer
    const listView = document.getElementById('presentations-list-view');
    const viewerView = document.getElementById('presentation-viewer');
    
    if (listView && viewerView) {
        listView.style.display = 'block';
        viewerView.classList.add('hidden');
        
        // Clear viewer content
        const content = document.getElementById('presentation-content');
        if (content) {
            content.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Загрузка презентации...</p></div>';
        }
    }
}

function loadPresentationContent(presentationId) {
    console.log('📥 Loading presentation content:', presentationId);
    
    const contentContainer = document.getElementById('presentation-content');
    const actionsContainer = document.getElementById('presentation-viewer-actions');
    
    if (!contentContainer) {
        console.error('❌ Presentation content container not found');
        return;
    }
    
    // Show loading
    contentContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Загрузка презентации...</p></div>';
    
    // Fetch presentation data from the new JSON API
    fetch(`/api/manager/presentation/${presentationId}`)
        .then(response => response.json())
        .then(data => {
            console.log('🎯 API response data:', data);
            if (data.success) {
                const presentation = data.presentation;
                console.log('✅ Presentation data:', presentation);
                console.log('🏠 Properties count:', presentation.properties ? presentation.properties.length : 'no properties');
                
                // Generate presentation content in dashboard style
                const generatedHTML = generatePresentationHTML(presentation);
                console.log('🏗️ Generated HTML length:', generatedHTML.length);
                console.log('📝 Generated HTML preview:', generatedHTML.substring(0, 200));
                
                contentContainer.innerHTML = generatedHTML;
        console.log('📋 Content container after update:', contentContainer);
        console.log('📋 Container visible:', contentContainer.style.display);
        console.log('📋 Container HTML length:', contentContainer.innerHTML.length);
        
        // Force visibility
        contentContainer.style.display = 'block';
        contentContainer.style.visibility = 'visible';
        contentContainer.style.opacity = '1';
                
                // Add actions buttons
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="sharePresentation('${presentationId}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-share mr-2"></i>Поделиться
                        </button>
                        <button onclick="downloadAllPresentation('${presentationId}', '${presentation.title}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-download mr-2"></i>Скачать все
                        </button>
                        <button onclick="sharePresentation('${presentationId}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-link mr-2"></i>Ссылка
                        </button>
                    `;
                }
                
                console.log('✅ Presentation loaded successfully in dashboard style');
                
            } else {
                contentContainer.innerHTML = `<div class="text-center py-8"><p class="text-red-500">Ошибка: ${data.error}</p></div>`;
            }
        })
        .catch(error => {
            console.error('❌ Error loading presentation:', error);
            contentContainer.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Ошибка загрузки презентации</p></div>';
        });
}

// Function to count unique residential complexes in properties
function getUniqueComplexesCount(properties) {
    if (!properties || !Array.isArray(properties)) return 0;
    
    const uniqueComplexes = new Set();
    properties.forEach(property => {
        if (property.residential_complex || property.complex_name) {
            uniqueComplexes.add(property.residential_complex || property.complex_name);
        }
    });
    
    return uniqueComplexes.size;
}

function generatePresentationHTML(presentation) {
    // Generate presentation header
    let html = `
        <div class="mb-8">
            <div class="bg-gray-50 rounded-xl p-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">${presentation.title || 'Без названия'}</h1>
                ${presentation.description ? `<p class="text-lg text-gray-600 mb-4">${presentation.description}</p>` : ''}
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">${presentation.properties_count}</div>
                        <div class="text-sm text-gray-600">Объектов</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">${presentation.view_count || 0}</div>
                        <div class="text-sm text-gray-600">Просмотров</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">${presentation.client_name || 'Не указан'}</div>
                        <div class="text-sm text-gray-600">Клиент</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">
                            ${getUniqueComplexesCount(presentation.properties || [])}
                        </div>
                        <div class="text-sm text-gray-600">ЖК</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Generate properties grid
    if (presentation.properties && presentation.properties.length > 0) {
        html += `
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Объекты недвижимости</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        `;
        
        presentation.properties.forEach(property => {
            html += generatePropertyCard(property, presentation.id);
        });
        
        html += `
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="text-center py-12">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-home text-6xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Нет объектов</h3>
                <p class="text-gray-500">В этой презентации пока нет добавленных объектов</p>
            </div>
        `;
    }
    
    return html;
}

function generatePropertyCard(property, presentationId) {
    const formatPrice = (price) => {
        return price ? price.toLocaleString('ru-RU') + ' ₽' : 'Цена не указана';
    };
    
    const formatArea = (area) => {
        return area ? area + ' м²' : 'Не указана';
    };
    
    const formatRooms = (rooms) => {
        if (rooms === 0) return 'Студия';
        return rooms ? rooms + '-комн.' : 'Не указано';
    };
    
    const getCashbackBadge = (property) => {
        if (property.cashback && property.cashback > 0) {
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-coins mr-1"></i>Кэшбэк ${property.cashback.toLocaleString('ru-RU')} ₽
                    </span>`;
        }
        return '';
    };
    
    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
            <!-- Property Image -->
            <div class="relative h-48">
                <img src="${property.main_image || '/static/images/no-photo.jpg'}" 
                     alt="${property.title || 'Объект недвижимости'}"
                     class="w-full h-full object-cover">
                
                <!-- Badges -->
                <div class="absolute top-3 left-3 flex flex-col space-y-2">
                    ${property.rooms === 0 ? 
                        '<span class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-medium">Студия</span>' :
                        `<span class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-medium">${property.rooms}-комн.</span>`
                    }
                    ${getCashbackBadge(property)}
                </div>
                
                <!-- Manager Note -->
                ${property.manager_note ? 
                    `<div class="absolute bottom-3 left-3 right-3">
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-2">
                            <p class="text-xs text-gray-700"><i class="fas fa-sticky-note mr-1"></i>${property.manager_note}</p>
                        </div>
                    </div>` : ''
                }
            </div>
            
            <!-- Property Info -->
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 text-lg mb-2">${property.title || 'Объект недвижимости'}</h3>
                
                <!-- Complex and Address -->
                <div class="text-sm text-gray-600 mb-3">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-building mr-2 text-gray-400"></i>
                        <span>${property.complex_name || 'ЖК не указан'}</span>
                    </div>
                    ${property.address ? 
                        `<div class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                            <span>${property.address}</span>
                        </div>` : ''
                    }
                </div>
                
                <!-- Key Info Grid -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="text-center bg-gray-50 rounded-lg p-2">
                        <div class="text-lg font-semibold text-gray-900">${formatPrice(property.price)}</div>
                        <div class="text-xs text-gray-500">Цена</div>
                    </div>
                    <div class="text-center bg-gray-50 rounded-lg p-2">
                        <div class="text-lg font-semibold text-gray-900">${formatArea(property.area)}</div>
                        <div class="text-xs text-gray-500">Площадь</div>
                    </div>
                </div>
                
                <!-- Additional Info -->
                <div class="grid grid-cols-3 gap-2 text-xs text-gray-600 mb-4">
                    <div class="text-center">
                        <div class="font-medium">${property.floor}/${property.total_floors}</div>
                        <div>Этаж</div>
                    </div>
                    <div class="text-center">
                        <div class="font-medium">${property.developer || 'Не указан'}</div>
                        <div>Застройщик</div>
                    </div>
                    <div class="text-center">
                        <div class="font-medium">${property.district || 'Не указан'}</div>
                        <div>Район</div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="pt-3 border-t border-gray-100">
                    <!-- Compact Icon Actions Row -->
                    <div class="flex justify-center space-x-3 mb-3">
                        <button onclick="viewPropertyDetails('${property.id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="Подробная информация">
                            <i class="fas fa-eye text-sm"></i>
                        </button>
                        <button onclick="printProperty('${presentationId}', '${property.property_id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="Распечатать">
                            <i class="fas fa-print text-sm"></i>
                        </button>
                        <button onclick="downloadPropertyPDF('${presentationId}', '${property.property_id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="Скачать PDF">
                            <i class="fas fa-download text-sm"></i>
                        </button>
                        <button onclick="sharePropertyLink('${presentationId}', '${property.property_id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="Поделиться">
                            <i class="fas fa-share text-sm"></i>
                        </button>
                        <button onclick="removePropertyFromPresentation('${presentationId}', '${property.property_id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="Удалить из презентации">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Add Comment Button -->
                    <div class="pt-2 border-t border-gray-100">
                        <button onclick="addPropertyComment('${presentationId}', '${property.property_id}')" 
                                class="w-full text-gray-600 hover:text-gray-800 text-sm py-1 hover:bg-gray-50 rounded transition-colors">
                            Добавить комментарий
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function viewPropertyDetails(propertyId) {
    // Open property in new tab
    window.open(`/object/${propertyId}`, '_blank');
}

function editPropertyNote(presentationId, propertyId) {
    const note = prompt('Введите комментарий к объекту:');
    if (note !== null) {
        // Update property note via API
        fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ comment: note })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Комментарий обновлен', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Ошибка при обновлении комментария', 'error');
        });
    }
}

function removePropertyFromPresentation(presentationId, propertyId) {
    if (confirm('Удалить объект из презентации?')) {
        fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Объект удален из презентации', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Ошибка при удалении объекта', 'error');
        });
    }
}

// PDF Download for individual property
function downloadPropertyPDF(presentationId, propertyId) {
    const downloadUrl = `/api/presentation/${presentationId}/property/${propertyId}/download`;
    
    // Create download link
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `property_${propertyId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('PDF скачивается...', 'success');
}

// Print individual property
function printProperty(presentationId, propertyId) {
    const printUrl = `/api/presentation/${presentationId}/property/${propertyId}/print`;
    const printWindow = window.open(printUrl, '_blank', 'width=800,height=600');
    
    if (printWindow) {
        printWindow.focus();
    } else {
        showNotification('Не удалось открыть окно печати', 'error');
    }
}

// Add comment to property
function addPropertyComment(presentationId, propertyId) {
    const comment = prompt('Введите комментарий к объекту:');
    if (comment !== null && comment.trim()) {
        fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ manager_note: comment.trim() })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Комментарий добавлен', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('Ошибка: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Ошибка при добавлении комментария', 'error');
        });
    }
}

// Share property link function
function sharePropertyLink(presentationId, propertyId) {
    const propertyUrl = `${window.location.origin}/object/${propertyId}`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(propertyUrl).then(() => {
        showNotification('Ссылка на объект скопирована', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = propertyUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Ссылка на объект скопирована', 'success');
    });
}

// Toggle presentation status between Черновик and Опубликовано
function togglePresentationStatus(presentationId, currentStatus) {
    // Определяем новый статус
    const newStatus = currentStatus === 'Черновик' ? 'Опубликовано' : 'Черновик';
    
    // Подтверждение действия
    if (!confirm(`Изменить статус на "${newStatus}"?`)) {
        return;
    }
    
    fetch(`/api/manager/presentation/${presentationId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Статус изменен на "${data.status}"`, 'success');
            // Перезагрузить содержимое презентации
            loadPresentationContent(presentationId);
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error updating presentation status:', error);
        showNotification('Ошибка при изменении статуса', 'error');
    });
}

function downloadAllPresentation(presentationId, title) {
    console.log(`🔥 Starting downloadAllPresentation for ID: ${presentationId}`);
    
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = `/api/manager/presentation/${presentationId}/download-all`;
    link.download = `${title || 'Презентация'} - Все материалы.zip`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Скачивание начато...', 'success');
}

function downloadPresentationPdf(presentationId, title) {
    console.log(`🔥 Starting downloadPresentationPdf for ID: ${presentationId}`);
    
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = `/api/presentation/pdf/${presentationId}`;
    link.download = `${title || 'Презентация'}.pdf`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Генерация PDF начата...', 'success');
}

function initializePresentationScripts() {
    // Initialize any additional functionality for presentation view
    console.log('✅ Presentation scripts initialized');
}

// ============================================================================
// FAVORITES FUNCTIONALITY FOR MANAGER DASHBOARD
// ============================================================================

// Global favorites data
let managerFavoriteProperties = [];
let managerFavoriteComplexes = [];
let favoritesPropertiesFiltered = [];
let favoritesComplexesFiltered = [];

// Load favorite properties from API
window.loadFavoriteProperties = function() {
    console.log('🔄 Loading favorite properties...');
    
    // Add delay to ensure DOM elements are available
    setTimeout(function() {
        const container = document.getElementById('properties-container');
        const emptyState = document.getElementById('empty-properties');
        const grid = document.getElementById('properties-grid');
        
        console.log('🔍 DOM elements check:', {
            container: container ? 'found' : 'NOT FOUND',
            emptyState: emptyState ? 'found' : 'NOT FOUND', 
            grid: grid ? 'found' : 'NOT FOUND'
        });
        
        // If elements not found, try alternative approach
        if (!container || !emptyState || !grid) {
            console.warn('⚠️ Primary elements not found, trying alternative selectors...');
            
            // Try finding elements within the specific section
            const section = document.getElementById('favorites');
            if (section) {
                const altContainer = section.querySelector('[id*="container"]');
                const altEmptyState = section.querySelector('[id*="empty"]');
                const altGrid = section.querySelector('[id*="grid"]');
                
                console.log('🔍 Alternative elements check:', {
                    section: 'found',
                    altContainer: altContainer ? 'found' : 'NOT FOUND',
                    altEmptyState: altEmptyState ? 'found' : 'NOT FOUND',
                    altGrid: altGrid ? 'found' : 'NOT FOUND'
                });
                
                if (!altContainer || !altEmptyState || !altGrid) {
                    console.error('❌ Could not find favorite properties elements after retries');
                    return;
                }
            } else {
                console.error('❌ Could not find favorite-properties section');
                return;
            }
        }
        
        // Show loading state
        if (container) container.classList.add('manager-favorites-hidden');
        if (emptyState) {
            emptyState.innerHTML = `
                <div class="text-center py-16">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-500">Загрузка избранных объектов...</p>
                </div>
            `;
            emptyState.classList.remove('manager-favorites-hidden');
        }
        
        // Load from API
        console.log('🌐 Calling /api/manager/favorites/list');
        fetch('/api/manager/favorites/list')
            .then(response => response.json())
            .then(data => {
                console.log('📦 API response:', data);
                if (data.success) {
                    managerFavoriteProperties = data.favorites || [];
                    favoritesPropertiesFiltered = [...managerFavoriteProperties];
                    
                    console.log('✅ Loaded', managerFavoriteProperties.length, 'favorite properties');
                    console.log('📊 Sample data:', managerFavoriteProperties.slice(0, 2));
                    
                    displayFavoriteProperties();
                    updateFavoritesCounts();
                    populatePropertiesFilters();
                } else {
                    console.error('❌ API error:', data.error);
                    showEmptyFavoriteProperties('Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('💥 Network error:', error);
                showEmptyFavoriteProperties('Ошибка сети при загрузке избранного');
            });
    }, 100); // 100ms delay to ensure DOM is ready
};

// Load favorite complexes from API
window.loadFavoriteComplexes = function() {
    console.log('🔄 Loading favorite complexes...');
    
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-favorite-complexes');
    const grid = document.getElementById('favorite-complexes-grid');
    
    if (!container || !emptyState || !grid) {
        console.error('❌ Favorite complexes elements not found');
        return;
    }
    
    // Show loading state
    container.classList.add('manager-favorites-hidden');
    emptyState.innerHTML = `
        <div class="text-center py-16">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-500">Загрузка избранных ЖК...</p>
        </div>
    `;
    emptyState.classList.remove('manager-favorites-hidden');
    
    // Load from API
    fetch('/api/manager/complexes/favorites/list')
        .then(response => response.json())
        .then(data => {
            console.log('📦 Complexes list API payload:', data);
            if (data.success) {
                // ИСПРАВЛЕНИЕ: добавить fallback чтение с диагностикой
                const items = data.complexes || data.favorite_complexes || data.favorites || [];
                console.log('🔍 Fallback reading result:', {
                    'data.complexes': data.complexes?.length || 0,
                    'data.favorite_complexes': data.favorite_complexes?.length || 0, 
                    'data.favorites': data.favorites?.length || 0,
                    'final_items_count': items.length
                });
                
                managerFavoriteComplexes = items;
                favoritesComplexesFiltered = [...managerFavoriteComplexes];
                
                console.log('✅ Loaded', managerFavoriteComplexes.length, 'favorite complexes');
                if (managerFavoriteComplexes.length > 0) {
                    console.log('📊 Sample complex data:', managerFavoriteComplexes[0]);
                }
                
                displayFavoriteComplexes();
                updateFavoritesCounts();
                populateComplexesFilters();
            } else {
                console.error('❌ API error:', data.error);
                showEmptyFavoriteComplexes('Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('💥 Network error:', error);
            showEmptyFavoriteComplexes('Ошибка сети при загрузке избранного');
        });
};

// Display favorite properties
function displayFavoriteProperties() {
    console.log('🎯 displayFavoriteProperties called, data length:', favoritesPropertiesFiltered?.length);
    
    // First try direct element lookup
    let container = document.getElementById('properties-container');
    let emptyState = document.getElementById('empty-properties');
    let grid = document.getElementById('properties-grid');
    let totalCount = document.getElementById('favorites-properties-total-count');
    let clearBtn = document.getElementById('clear-all-properties');
    let exportBtn = document.getElementById('export-properties');
    
    console.log('🔍 Display DOM elements check:', {
        container: container ? 'found' : 'NOT FOUND',
        emptyState: emptyState ? 'found' : 'NOT FOUND',
        grid: grid ? 'found' : 'NOT FOUND',
        totalCount: totalCount ? 'found' : 'NOT FOUND'
    });
    
    // If elements not found, try alternative approach
    if (!container || !emptyState || !grid) {
        console.warn('⚠️ Primary display elements not found, trying alternative selectors...');
        
        // Try finding elements within the specific section
        const section = document.getElementById('favorites');
        if (section) {
            if (!container) container = section.querySelector('[id*="container"]');
            if (!emptyState) emptyState = section.querySelector('[id*="empty"]');
            if (!grid) grid = section.querySelector('[id*="grid"]');
            if (!totalCount) totalCount = section.querySelector('[id*="total-count"]');
            if (!clearBtn) clearBtn = section.querySelector('[id*="clear-all"]');
            if (!exportBtn) exportBtn = section.querySelector('[id*="export"]');
            
            console.log('🔍 Alternative display elements check:', {
                section: 'found',
                container: container ? 'found' : 'NOT FOUND',
                emptyState: emptyState ? 'found' : 'NOT FOUND',
                grid: grid ? 'found' : 'NOT FOUND'
            });
        }
        
        if (!container || !emptyState || !grid) {
            console.error('❌ Required display elements still not found after retries!');
            return;
        }
    }
    
    if (favoritesPropertiesFiltered.length === 0) {
        console.log('📭 No properties to display, showing empty state');
        showEmptyFavoriteProperties();
        return;
    }
    
    // Update counts and show controls
    if (totalCount) {
        totalCount.textContent = favoritesPropertiesFiltered.length;
        console.log('📊 Updated total count to:', favoritesPropertiesFiltered.length);
    }
    if (clearBtn) clearBtn.classList.remove('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.remove('manager-favorites-hidden');
    
    // Hide empty state and show container
    console.log('👀 Showing container and hiding empty state');
    emptyState.classList.add('manager-favorites-hidden');
    container.classList.remove('manager-favorites-hidden');
    
    // 🔧 FORCE SHOW CONTAINER - bypass CSS !important
    container.style.display = 'block';
    console.log('🔧 Forced container visibility with style.display = block');
    
    // Generate property cards
    const cardsHTML = favoritesPropertiesFiltered.map(property => createPropertyCard(property)).join('');
    console.log('🏗️ Generated HTML length:', cardsHTML.length);
    console.log('📝 Sample HTML (first 200 chars):', cardsHTML.substring(0, 200));
    
    grid.innerHTML = cardsHTML;
    
    
    console.log('✅ Displayed', favoritesPropertiesFiltered.length, 'properties');
    console.log('🧮 Grid children count:', grid.children.length);
}

// Display favorite complexes
function displayFavoriteComplexes() {
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-favorite-complexes');
    const grid = document.getElementById('favorite-complexes-grid');
    const totalCount = document.getElementById('favorites-complexes-total-count');
    const clearBtn = document.getElementById('clear-all-complexes');
    const exportBtn = document.getElementById('export-complexes');
    
    if (favoritesComplexesFiltered.length === 0) {
        showEmptyFavoriteComplexes();
        return;
    }
    
    // Update counts and show controls
    if (totalCount) totalCount.textContent = favoritesComplexesFiltered.length;
    if (clearBtn) clearBtn.classList.remove('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.remove('manager-favorites-hidden');
    
    // Hide empty state and show container
    emptyState.classList.add('manager-favorites-hidden');
    container.classList.remove('manager-favorites-hidden');
    
    // 🔧 FORCE SHOW CONTAINER - bypass CSS !important
    container.style.display = 'block';
    console.log('🔧 Forced complexes container visibility with style.display = block');
    
    // Generate complex cards
    grid.innerHTML = favoritesComplexesFiltered.map(complex => createComplexCard(complex)).join('');
    
    console.log('✅ Displayed', favoritesComplexesFiltered.length, 'complexes');
}

// Create property card HTML for manager dashboard
function createPropertyCard(property) {
    console.log('🏗️ Creating card for property:', property.id || property.property_id, property);
    
    // Use correct field names from API response
    const propertyId = property.id || property.property_id;
    const price = property.price || property.property_price || 0;
    const title = property.title || property.property_name || 'Объект';
    const district = property.district || property.property_district || '';
    const complex = property.complex || property.property_complex || '';
    const cashback = property.cashback_amount || Math.floor(price * 0.05);
    const imageUrl = property.image || property.property_image_url || '/static/images/placeholder-property.jpg';
    const createdAt = property.created_at || property.added_at || 'Недавно';
    const notes = property.notes || property.recommended_for || '';
    
    // Extract area from title if available (e.g. "Студия, 22.82 м²")
    const areaMatch = title.match(/(\d+(?:\.\d+)?)\s*м²/);
    const area = areaMatch ? parseFloat(areaMatch[1]) : 0;
    const pricePerSqm = area > 0 ? Math.floor(price / area) : 0;
    
    return `
        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow property-favorite-card" data-property-id="${propertyId}">
            <div class="relative">
                <img src="${imageUrl}" alt="${title}" class="w-full h-48 object-cover rounded-t-xl" 
                     onerror="this.src='/static/images/placeholder-property.jpg'">
                <!-- Cashback Badge -->
                <div class="absolute top-3 left-3 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium">
                    Кэшбек ${cashback.toLocaleString('ru-RU')} ₽
                </div>
                
                <!-- Favorite Heart -->
                <div class="absolute top-3 right-3 favorite-heart favorited" data-property-id="${propertyId}" title="Удалить из избранного">
                    <i class="fas fa-heart text-red-500"></i>
                </div>
            </div>
            
            <div class="p-4">
                <h3 class="font-semibold text-lg mb-2">${title}</h3>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                    ${district}
                    ${complex ? ', ' + complex : ''}
                </p>
                
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="text-xl font-bold text-[#0088CC]">
                            ${price.toLocaleString('ru-RU')} ₽
                        </div>
                        ${pricePerSqm > 0 ? `
                        <div class="text-sm text-gray-500">
                            ${pricePerSqm.toLocaleString('ru-RU')} ₽/м²
                        </div>
                        ` : ''}
                    </div>
                    <div class="text-right text-sm text-gray-500">
                        Добавлено: ${createdAt}
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <a href="/object/${propertyId}" class="flex-1 bg-[#0088CC] text-white text-center py-2 rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        Подробнее
                    </a>
                    <button onclick="addToPresentation(${propertyId})" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm" title="В презентацию">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button onclick="removeFromFavorites(${propertyId})" class="px-3 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition-colors text-sm" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                ${notes ? `
                <div class="mt-3 p-2 bg-gray-50 rounded text-sm">
                    <strong>Заметки:</strong> ${notes}
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Create complex card HTML
function createComplexCard(complex) {
    const imageUrl = complex.complex_image_url || '/static/images/placeholder-complex.jpg';
    const district = complex.complex_district || '';
    const developer = complex.complex_developer || '';
    const status = complex.complex_status || '';
    const addedDate = complex.added_at ? new Date(complex.added_at).toLocaleDateString('ru-RU') : '';
    const priceFrom = complex.complex_price_from ? formatPrice(complex.complex_price_from) : '';
    
    const statusColors = {
        'строится': 'bg-yellow-100 text-yellow-800',
        'сдан': 'bg-green-100 text-green-800',
        'проект': 'bg-blue-100 text-blue-800'
    };
    const statusColor = statusColors[status.toLowerCase()] || 'bg-gray-100 text-gray-800';
    
    return `
        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow complex-favorite-card" data-complex-id="${complex.complex_id}">
            <div class="relative">
                <img src="${imageUrl}" alt="${complex.complex_name}" class="w-full h-48 object-cover rounded-t-xl">
                <div class="absolute top-3 right-3 flex gap-2">
                    <button onclick="removeFavoriteComplex('${complex.complex_id}')" 
                            class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors"
                            title="Удалить из избранного">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                ${status ? `<div class="absolute top-3 left-3 ${statusColor} px-2 py-1 rounded text-sm font-medium">${status}</div>` : ''}
            </div>
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-900 text-lg">${complex.complex_name || 'ЖК'}</h3>
                    <span class="text-xs text-gray-500">Добавлено: ${addedDate}</span>
                </div>
                ${priceFrom ? `<p class="text-xl font-bold text-[#0088CC] mb-3">от ${priceFrom}</p>` : ''}
                
                <div class="space-y-2 text-sm text-gray-600 mb-4">
                    ${district ? `<div class="flex items-center gap-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg><span>${district}</span></div>` : ''}
                    ${developer ? `<div class="flex items-center gap-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>${developer}</span></div>` : ''}
                    ${complex.complex_properties_count ? `<div class="flex items-center gap-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM9 16a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z"/></svg><span>${complex.complex_properties_count} квартир</span></div>` : ''}
                </div>
                
                <div class="flex gap-2">
                    <button onclick="viewComplexDetails('${complex.complex_id}')" 
                            class="flex-1 bg-[#0088CC] text-white py-2 px-3 rounded-lg text-sm hover:bg-[#006699] transition-colors">
                        Подробнее
                    </button>
                    <button onclick="searchComplexProperties('${complex.complex_id}')" 
                            class="flex-1 bg-purple-500 text-white py-2 px-3 rounded-lg text-sm hover:bg-purple-600 transition-colors">
                        Квартиры в ЖК
                    </button>
                </div>
                
                ${complex.manager_note ? `<div class="mt-3 p-2 bg-yellow-50 rounded text-sm"><strong>Заметка:</strong> ${complex.manager_note}</div>` : ''}
            </div>
        </div>
    `;
}

// Show empty state for properties
function showEmptyFavoriteProperties(message = null) {
    const container = document.getElementById('properties-container');
    const emptyState = document.getElementById('empty-properties');
    const totalCount = document.getElementById('favorites-properties-total-count');
    const clearBtn = document.getElementById('clear-all-properties');
    const exportBtn = document.getElementById('export-properties');
    
    if (container) container.classList.add('manager-favorites-hidden');
    if (clearBtn) clearBtn.classList.add('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.add('manager-favorites-hidden');
    if (totalCount) totalCount.textContent = '0';
    
    if (message) {
        emptyState.innerHTML = `
            <div class="text-center py-16">
                <svg class="w-24 h-24 text-red-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-red-600 text-lg font-medium">${message}</p>
            </div>
        `;
    }
    
    if (emptyState) emptyState.classList.remove('manager-favorites-hidden');
}

// Show empty state for complexes
function showEmptyFavoriteComplexes(message = null) {
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-favorite-complexes');
    const totalCount = document.getElementById('favorites-complexes-total-count');
    const clearBtn = document.getElementById('clear-all-complexes');
    const exportBtn = document.getElementById('export-complexes');
    
    if (container) container.classList.add('manager-favorites-hidden');
    if (clearBtn) clearBtn.classList.add('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.add('manager-favorites-hidden');
    if (totalCount) totalCount.textContent = '0';
    
    if (message) {
        emptyState.innerHTML = `
            <div class="text-center py-16">
                <svg class="w-24 h-24 text-red-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-red-600 text-lg font-medium">${message}</p>
            </div>
        `;
    }
    
    if (emptyState) emptyState.classList.remove('manager-favorites-hidden');
}

// Update favorites counts in navigation
function updateFavoritesCounts() {
    console.log('🔢 updateFavoritesCounts called');
    
    const propertiesNavCount = document.getElementById('favorites-properties-count');
    const complexesNavCount = document.getElementById('favorites-complexes-count');
    
    console.log('🔍 Count elements check:', {
        propertiesNavCount: propertiesNavCount ? 'found' : 'NOT FOUND',
        complexesNavCount: complexesNavCount ? 'found' : 'NOT FOUND'
    });
    
    // Update local counts first
    const propertiesCount = managerFavoriteProperties?.length || 0;
    const complexesCount = managerFavoriteComplexes?.length || 0;
    
    console.log('📊 Local counts - properties:', propertiesCount, 'complexes:', complexesCount);
    
    if (propertiesNavCount) {
        propertiesNavCount.textContent = propertiesCount;
        console.log('✅ Updated properties nav count to:', propertiesCount);
    }
    if (complexesNavCount) {
        complexesNavCount.textContent = complexesCount;
        console.log('✅ Updated complexes nav count to:', complexesCount);
    }
    
    // Also make API call to ensure sync
    console.log('🌐 Making API call to /api/manager/favorites/count for sync');
    fetch('/api/manager/favorites/count')
        .then(response => response.json())
        .then(data => {
            console.log('📦 Count API response:', data);
            if (data.success) {
                // Update specific count elements
                if (propertiesNavCount) {
                    propertiesNavCount.textContent = data.properties_count;
                    console.log('🔄 Synced properties count to:', data.properties_count);
                }
                if (complexesNavCount) {
                    complexesNavCount.textContent = data.complexes_count;
                    console.log('🔄 Synced complexes count to:', data.complexes_count);
                }
                
                // Update total favorites count in horizontal menu
                const totalFavoritesCount = document.getElementById('favorites-total-count');
                if (totalFavoritesCount && data.total_count !== undefined) {
                    totalFavoritesCount.textContent = data.total_count;
                    console.log('🔄 Synced total favorites count to:', data.total_count);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching favorites count:', error);
        });
    
    // Also update comparison count
    console.log('🌐 Making API call to /api/manager/comparison/count for comparison sync');
    fetch('/api/manager/comparison/count')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Comparison API response:', data);
            if (data.success) {
                const comparisonCount = document.getElementById('comparison-count');
                if (comparisonCount && data.total_count !== undefined) {
                    comparisonCount.textContent = data.total_count;
                    console.log('🔄 Synced comparison count to:', data.total_count);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching comparison count:', error);
        });
}

// Initialize favorites counts on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load initial counts
    updateFavoritesCounts();
    
    // DISABLED - conflicts with presentation viewer 
    // setInterval(updateFavoritesCounts, 30000);
});

// Remove favorite property
window.removeFavoriteProperty = function(propertyId) {
    if (!confirm('Удалить этот объект из избранного?')) {
        return;
    }
    
    fetch(`/api/manager/favorites/${propertyId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Объект удален из избранного', 'success');
            // Reload the favorites
            loadFavoriteProperties();
        } else {
            showNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing favorite:', error);
        showNotification('Ошибка при удалении из избранного', 'error');
    });
};

// Remove favorite complex
window.removeFavoriteComplex = function(complexId) {
    if (!confirm('Удалить этот ЖК из избранного?')) {
        return;
    }
    
    fetch(`/api/manager/complexes/favorites/${complexId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('ЖК удален из избранного', 'success');
            // Reload the favorites
            loadFavoriteComplexes();
        } else {
            showNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing favorite complex:', error);
        showNotification('Ошибка при удалении из избранного', 'error');
    });
};

// Clear all favorite properties
window.clearAllFavoriteProperties = function() {
    if (!confirm('Вы уверены, что хотите удалить все избранные объекты? Это действие нельзя отменить.')) {
        return;
    }
    
    // Remove all properties one by one
    const promises = managerFavoriteProperties.map(property => 
        fetch(`/api/manager/favorites/${property.property_id}`, { method: 'DELETE' })
    );
    
    Promise.all(promises)
        .then(responses => {
            const failedCount = responses.filter(r => !r.ok).length;
            if (failedCount === 0) {
                showNotification('Все объекты удалены из избранного', 'success');
                loadFavoriteProperties();
            } else {
                showNotification(`Удалено, но ${failedCount} объектов не удалось удалить`, 'warning');
                loadFavoriteProperties();
            }
        })
        .catch(error => {
            console.error('Error clearing favorites:', error);
            showNotification('Ошибка при очистке избранного', 'error');
        });
};

// Clear all favorite complexes
window.clearAllFavoriteComplexes = function() {
    if (!confirm('Вы уверены, что хотите удалить все избранные ЖК? Это действие нельзя отменить.')) {
        return;
    }
    
    // Remove all complexes one by one
    const promises = managerFavoriteComplexes.map(complex => 
        fetch(`/api/manager/complexes/favorites/${complex.complex_id}`, { method: 'DELETE' })
    );
    
    Promise.all(promises)
        .then(responses => {
            const failedCount = responses.filter(r => !r.ok).length;
            if (failedCount === 0) {
                showNotification('Все ЖК удалены из избранного', 'success');
                loadFavoriteComplexes();
            } else {
                showNotification(`Удалено, но ${failedCount} ЖК не удалось удалить`, 'warning');
                loadFavoriteComplexes();
            }
        })
        .catch(error => {
            console.error('Error clearing favorite complexes:', error);
            showNotification('Ошибка при очистке избранного', 'error');
        });
};

// Filtering and sorting functions
window.filterFavoriteProperties = function() {
    const roomsFilter = document.getElementById('filter-favorite-rooms')?.value || '';
    const districtFilter = document.getElementById('filter-favorite-district')?.value || '';
    const priceFilter = document.getElementById('filter-favorite-price')?.value || '';
    
    favoritesPropertiesFiltered = managerFavoriteProperties.filter(property => {
        // Rooms filter
        if (roomsFilter && property.property_rooms && !property.property_rooms.toLowerCase().includes(roomsFilter.toLowerCase())) {
            return false;
        }
        
        // District filter
        if (districtFilter && property.property_district && !property.property_district.toLowerCase().includes(districtFilter.toLowerCase())) {
            return false;
        }
        
        // Price filter
        if (priceFilter && property.property_price) {
            const maxPrice = parseInt(priceFilter);
            if (property.property_price > maxPrice) {
                return false;
            }
        }
        
        return true;
    });
    
    displayFavoriteProperties();
};

window.filterFavoriteComplexes = function() {
    const statusFilter = document.getElementById('filter-complex-status')?.value || '';
    const districtFilter = document.getElementById('filter-complex-district')?.value || '';
    const developerFilter = document.getElementById('filter-complex-developer')?.value || '';
    
    favoritesComplexesFiltered = managerFavoriteComplexes.filter(complex => {
        // Status filter
        if (statusFilter && complex.complex_status && !complex.complex_status.toLowerCase().includes(statusFilter.toLowerCase())) {
            return false;
        }
        
        // District filter
        if (districtFilter && complex.complex_district && !complex.complex_district.toLowerCase().includes(districtFilter.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developerFilter && complex.complex_developer && !complex.complex_developer.toLowerCase().includes(developerFilter.toLowerCase())) {
            return false;
        }
        
        return true;
    });
    
    displayFavoriteComplexes();
};

window.sortFavoriteProperties = function() {
    const sortBy = document.getElementById('sort-favorite-properties')?.value || 'date_desc';
    
    favoritesPropertiesFiltered.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return new Date(a.added_at) - new Date(b.added_at);
            case 'date_desc':
                return new Date(b.added_at) - new Date(a.added_at);
            case 'price_asc':
                return (a.property_price || 0) - (b.property_price || 0);
            case 'price_desc':
                return (b.property_price || 0) - (a.property_price || 0);
            case 'area_asc':
                return (a.property_area || 0) - (b.property_area || 0);
            case 'area_desc':
                return (b.property_area || 0) - (a.property_area || 0);
            default:
                return 0;
        }
    });
    
    displayFavoriteProperties();
};

window.sortFavoriteComplexes = function() {
    const sortBy = document.getElementById('sort-favorite-complexes')?.value || 'date_desc';
    
    favoritesComplexesFiltered.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return new Date(a.added_at) - new Date(b.added_at);
            case 'date_desc':
                return new Date(b.added_at) - new Date(a.added_at);
            case 'name_asc':
                return (a.complex_name || '').localeCompare(b.complex_name || '');
            case 'price_asc':
                return (a.complex_price_from || 0) - (b.complex_price_from || 0);
            case 'price_desc':
                return (b.complex_price_from || 0) - (a.complex_price_from || 0);
            default:
                return 0;
        }
    });
    
    displayFavoriteComplexes();
};

// Populate filter dropdowns
function populatePropertiesFilters() {
    const districtFilter = document.getElementById('filter-favorite-district');
    
    if (districtFilter && managerFavoriteProperties.length > 0) {
        const districts = [...new Set(managerFavoriteProperties
            .map(p => p.property_district)
            .filter(d => d))];
        
        districtFilter.innerHTML = '<option value="">Все районы</option>' +
            districts.map(district => `<option value="${district}">${district}</option>`).join('');
    }
}

function populateComplexesFilters() {
    const districtFilter = document.getElementById('filter-complex-district');
    const developerFilter = document.getElementById('filter-complex-developer');
    
    if (districtFilter && managerFavoriteComplexes.length > 0) {
        const districts = [...new Set(managerFavoriteComplexes
            .map(c => c.complex_district)
            .filter(d => d))];
        
        districtFilter.innerHTML = '<option value="">Все районы</option>' +
            districts.map(district => `<option value="${district}">${district}</option>`).join('');
    }
    
    if (developerFilter && managerFavoriteComplexes.length > 0) {
        const developers = [...new Set(managerFavoriteComplexes
            .map(c => c.complex_developer)
            .filter(d => d))];
        
        developerFilter.innerHTML = '<option value="">Все застройщики</option>' +
            developers.map(developer => `<option value="${developer}">${developer}</option>`).join('');
    }
}

// Action functions
window.viewPropertyDetails = function(propertyId) {
    window.open(`/object/${propertyId}`, '_blank');
};

window.viewComplexDetails = function(complexId) {
    window.open(`/complex/${complexId}`, '_blank');
};

window.addToCollection = function(propertyId) {
    // Show collection selection modal or redirect to create collection with pre-selected property
    showSection('create-collection');
    // TODO: Pre-select the property in collection creation form
    showNotification('Перейдите к созданию подборки и добавьте этот объект', 'info');
};

window.searchComplexProperties = function(complexId) {
    window.open(`/properties?complex=${complexId}`, '_blank');
};

// Export functions
window.exportFavoriteProperties = function() {
    if (managerFavoriteProperties.length === 0) {
        showNotification('Нет объектов для экспорта', 'warning');
        return;
    }
    
    // Create CSV data
    const headers = ['Название', 'Цена', 'Площадь', 'Комнаты', 'Район', 'ЖК', 'Застройщик', 'Дата добавления'];
    const rows = managerFavoriteProperties.map(property => [
        property.property_name || '',
        property.property_price || '',
        property.property_area || '',
        property.property_rooms || '',
        property.property_district || '',
        property.property_complex || '',
        property.property_developer || '',
        property.added_at ? new Date(property.added_at).toLocaleDateString('ru-RU') : ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `favorite-properties-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('Экспорт избранных объектов начат', 'success');
};

window.exportFavoriteComplexes = function() {
    if (managerFavoriteComplexes.length === 0) {
        showNotification('Нет ЖК для экспорта', 'warning');
        return;
    }
    
    // Create CSV data
    const headers = ['Название', 'Цена от', 'Район', 'Застройщик', 'Статус', 'Дата добавления'];
    const rows = managerFavoriteComplexes.map(complex => [
        complex.complex_name || '',
        complex.complex_price_from || '',
        complex.complex_district || '',
        complex.complex_developer || '',
        complex.complex_status || '',
        complex.added_at ? new Date(complex.added_at).toLocaleDateString('ru-RU') : ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `favorite-complexes-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('Экспорт избранных ЖК начат', 'success');
};

// ================================================
// NEW WORKING FAVORITES SECTIONS with Flexbox
// ================================================

// Load new favorite properties with simple layout
window.loadNewFavoriteProperties = async function() {
    console.log('🆕 Loading NEW favorite properties with Flexbox layout...');
    
    try {
        const response = await fetch('/api/manager/favorites/list');
        const data = await response.json();
        
        if (!data.success) {
            console.error('❌ Failed to load favorites:', data);
            return;
        }
        
        const properties = data.favorites || [];
        console.log(`📊 Loaded ${properties.length} properties for NEW section`);
        
        // Update count in navigation widget
        const countEl = document.getElementById('new-properties-count');
        if (countEl) countEl.textContent = properties.length;
        
        // Update count in section header
        const totalEl = document.getElementById('new-properties-total');
        if (totalEl) totalEl.textContent = properties.length;
        
        // Get containers
        const emptyState = document.getElementById('new-empty-properties');
        const container = document.getElementById('new-properties-container');
        const list = document.getElementById('new-properties-list');
        
        if (properties.length === 0) {
            emptyState.classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }
        
        // Hide empty state, show container
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Simple card creation with Flexbox
        list.innerHTML = properties.map(property => `
            <div class="bg-white rounded-lg shadow-sm border p-4 w-80 hover:shadow-md transition-shadow">
                <div class="relative mb-3">
                    <img src="${property.image || '/static/images/no-photo.jpg'}" 
                         alt="${property.title}" 
                         class="w-full h-48 object-cover rounded-lg"
                         onerror="this.src='/static/images/no-photo.jpg'">
                    <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-sm">
                        ₽${Number(property.cashback_amount || 0).toLocaleString('ru-RU')}
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">${property.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${property.complex}</p>
                <p class="text-lg font-bold text-blue-600">₽${Number(property.price || 0).toLocaleString('ru-RU')}</p>
                <div class="mt-3 text-xs text-gray-500">
                    Добавлено: ${property.created_at}
                </div>
            </div>
        `).join('');
        
        console.log(`✅ NEW section displayed ${properties.length} properties successfully`);
        
    } catch (error) {
        console.error('❌ Error loading NEW favorite properties:', error);
    }
};

// Load new favorite complexes with simple layout
window.loadNewFavoriteComplexes = async function() {
    console.log('🆕 Loading NEW favorite complexes with Flexbox layout...');
    
    try {
        const response = await fetch('/api/manager/complexes/favorites/list');
        const data = await response.json();
        
        if (!data.success) {
            console.error('❌ Failed to load favorite complexes:', data);
            return;
        }
        
        const complexes = data.favorites || [];
        console.log(`📊 Loaded ${complexes.length} complexes for NEW section`);
        
        // Update count in navigation widget
        const countEl = document.getElementById('new-complexes-count');
        if (countEl) countEl.textContent = complexes.length;
        
        // Update count in section header
        const totalEl = document.getElementById('new-complexes-total');
        if (totalEl) totalEl.textContent = complexes.length;
        
        // Get containers
        const emptyState = document.getElementById('new-empty-complexes');
        const container = document.getElementById('new-complexes-container');
        const list = document.getElementById('new-complexes-list');
        
        if (complexes.length === 0) {
            emptyState.classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }
        
        // Hide empty state, show container
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Simple card creation with Flexbox
        list.innerHTML = complexes.map(complex => `
            <div class="bg-white rounded-lg shadow-sm border p-4 w-80 hover:shadow-md transition-shadow">
                <div class="relative mb-3">
                    <img src="${complex.image || '/static/images/no-photo.jpg'}" 
                         alt="${complex.name}" 
                         class="w-full h-48 object-cover rounded-lg"
                         onerror="this.src='/static/images/no-photo.jpg'">
                    <div class="absolute top-2 right-2 bg-blue-500 text-white px-2 py-1 rounded text-sm">
                        ${complex.status || 'ЖК'}
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">${complex.name}</h3>
                <p class="text-sm text-gray-600 mb-1">${complex.developer}</p>
                <p class="text-sm text-gray-600 mb-2">${complex.district}</p>
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        ${complex.min_price ? `от ₽${Number(complex.min_price).toLocaleString('ru-RU')}` : 'Цена не указана'}
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    Добавлено: ${complex.created_at}
                </div>
            </div>
        `).join('');
        
        console.log(`✅ NEW section displayed ${complexes.length} complexes successfully`);
        
    } catch (error) {
        console.error('❌ Error loading NEW favorite complexes:', error);
    }
};

// Export functions for new sections
window.exportNewFavoriteProperties = function() {
    console.log('📋 Exporting from NEW properties section...');
    showNotification('Экспорт из новой секции объектов', 'info');
};

window.exportNewFavoriteComplexes = function() {
    console.log('📋 Exporting from NEW complexes section...');
    showNotification('Экспорт из новой секции ЖК', 'info');
};

// Add section switching for new sections
document.addEventListener('DOMContentLoaded', function() {
    const originalShowSection = window.showSection;
    
    window.showSection = function(sectionId) {
        console.log(`🎯 NEW showSection called with: ${sectionId}`);
        
        if (sectionId === 'new-favorite-properties') {
            // Call original function first
            if (originalShowSection) originalShowSection(sectionId);
            // Then load data
            loadNewFavoriteProperties();
        } else if (sectionId === 'new-favorite-complexes') {
            // Call original function first
            if (originalShowSection) originalShowSection(sectionId);
            // Then load data
            loadNewFavoriteComplexes();
        } else if (sectionId === 'favorites') {
            // 🎯 HORIZONTAL TAB: Избранные объекты
            console.log('🎯 Favorite properties section selected - calling loadFavoriteProperties');
            if (originalShowSection) originalShowSection(sectionId);
            loadFavoriteProperties();
            updateFavoritesCounts();
        } else if (sectionId === 'favorite-complexes') {
            // 🎯 HORIZONTAL TAB: Избранные ЖК
            console.log('🎯 Favorite complexes section selected - calling loadFavoriteComplexes');
            if (originalShowSection) originalShowSection(sectionId);
            loadFavoriteComplexes();
            updateFavoritesCounts();
        } else {
            // Call original function for other sections
            if (originalShowSection) originalShowSection(sectionId);
        }
    };
    
    console.log('✅ NEW favorites functions registered');
    
    // 🎯 AUTO-SHOW FAVORITES: Show favorite-properties section by default if user has favorites
    // DISABLED AUTO-SWITCH TO FAVORITES - it conflicts with presentation viewer
    // setTimeout(() => {
    //     fetch('/api/manager/favorites/count')
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.success && data.properties_count > 0) {
    //                 console.log(`🎯 Auto-showing favorites section (${data.properties_count} properties found)`);
    //                 showSection('favorites');
    //             }
    //         })
    //         .catch(error => console.log('No auto-show for favorites:', error));
    // }, 1000);
    
    // 🔄 Load dashboard card counts
    console.log('🔢 Loading dashboard card counts...');
    fetch('/api/manager/favorites/count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update dashboard card counts
                const newPropCount = document.getElementById('new-properties-count');
                const newComplexCount = document.getElementById('new-complexes-count');
                
                if (newPropCount) {
                    newPropCount.textContent = data.properties_count || 0;
                    console.log(`📋 Updated properties card: ${data.properties_count || 0}`);
                }
                if (newComplexCount) {
                    newComplexCount.textContent = data.complexes_count || 0;
                    console.log(`📋 Updated complexes card: ${data.complexes_count || 0}`);
                }
                
                // Update horizontal tab counts
                const tabPropCount = document.getElementById('favorites-properties-count');
                const tabComplexCount = document.getElementById('favorites-complexes-count');
                
                if (tabPropCount) {
                    tabPropCount.textContent = data.properties_count || 0;
                    console.log(`🔗 Updated horizontal properties tab: ${data.properties_count || 0}`);
                }
                if (tabComplexCount) {
                    tabComplexCount.textContent = data.complexes_count || 0;
                    console.log(`🔗 Updated horizontal complexes tab: ${data.complexes_count || 0}`);
                }
                
                console.log(`✅ Dashboard cards updated successfully!`);
            }
        })
        .catch(error => console.error('❌ Error loading dashboard counts:', error));
});

// Utility functions
function formatPrice(price) {
    if (!price) return '';
    
    const numPrice = parseInt(price);
    if (numPrice >= 1000000) {
        return (numPrice / 1000000).toFixed(1) + ' млн ₽';
    } else if (numPrice >= 1000) {
        return (numPrice / 1000).toFixed(0) + ' тыс ₽';
    } else {
        return numPrice.toLocaleString('ru-RU') + ' ₽';
    }
}

// Устанавливаем флаг менеджера для системы сравнения
sessionStorage.setItem('is_manager', 'true');
console.log('🔑 Manager session flag set: true');

console.log('✅ Manager Favorites functionality initialized');

</script>


{% endblock %}